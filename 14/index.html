<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Veille Municipales 2026 - Communes √† risque ED</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #e4e4e4;
        }

        .header {
            background: rgba(0,0,0,0.3);
            padding: 20px;
            text-align: center;
            border-bottom: 2px solid #fef783;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            font-size: 1.8rem;
            margin-bottom: 8px;
        }

        .header-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .header-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .header-btn.primary {
            background: #e74c3c;
            color: white;
        }

        .header-btn.secondary {
            background: #1d4eff;
            color: white;
        }

        .header-btn.success {
            background: #27ae60;
            color: white;
        }

        .header-btn:hover {
            transform: scale(1.05);
            filter: brightness(1.1);
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            background: rgba(0,0,0,0.2);
            padding: 5px;
            border-radius: 10px;
            overflow-x: auto;
        }

        .tab {
            padding: 12px 24px;
            border: none;
            background: transparent;
            color: #888;
            cursor: pointer;
            border-radius: 8px;
            font-size: 0.95rem;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .tab:hover {
            color: #e4e4e4;
            background: rgba(255,255,255,0.05);
        }

        .tab.active {
            background: #1d4eff;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Stats */
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: rgba(255,255,255,0.05);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-card .number {
            font-size: 2rem;
            font-weight: bold;
            color: #fef783;
        }

        .stat-card .label {
            font-size: 0.85rem;
            color: #aaa;
            margin-top: 5px;
        }

        /* Filters */
        .filters {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
        }

        .filter-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
            background: rgba(255,255,255,0.1);
            color: #e4e4e4;
        }

        .filter-btn:hover, .filter-btn.active {
            transform: scale(1.05);
        }

        .filter-btn[data-score="E"] { background: #e74c3c; color: white; }
        .filter-btn[data-score="D"] { background: #e67e22; color: white; }
        .filter-btn[data-score="C"] { background: #f1c40f; color: #333; }
        .filter-btn[data-score="all"].active { background: #1d4eff; }

        .search-box {
            flex: 1;
            min-width: 200px;
        }

        .search-box input {
            width: 100%;
            padding: 10px 15px;
            border: none;
            border-radius: 20px;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 0.9rem;
        }

        .search-box input::placeholder {
            color: #888;
        }

        /* Grid */
        .communes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
            gap: 20px;
        }

        .commune-card {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.3s;
        }

        .commune-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .commune-header {
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            cursor: pointer;
        }

        .commune-name {
            font-size: 1.2rem;
            font-weight: bold;
        }

        .commune-dept {
            font-size: 0.85rem;
            color: #888;
        }

        .score-badge {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .score-E { background: #e74c3c; }
        .score-D { background: #e67e22; }
        .score-C { background: #f1c40f; color: #333; }
        .score-B { background: #27ae60; }

        .commune-body {
            padding: 15px;
        }

        .info-row {
            display: flex;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .info-label {
            color: #888;
            min-width: 100px;
        }

        .info-value {
            color: #e4e4e4;
        }

        /* Candidats section */
        .candidats-section {
            margin-top: 15px;
            border-top: 1px solid rgba(255,255,255,0.1);
            padding-top: 15px;
        }

        .candidats-section h4 {
            font-size: 0.9rem;
            color: #e74c3c;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .add-candidat-btn {
            padding: 4px 10px;
            font-size: 0.75rem;
            background: rgba(231, 76, 60, 0.3);
            border: 1px solid #e74c3c;
            color: #e74c3c;
            border-radius: 12px;
            cursor: pointer;
        }

        .candidat-item {
            background: rgba(231, 76, 60, 0.15);
            border-left: 3px solid #e74c3c;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 0 8px 8px 0;
        }

        .candidat-item .name {
            font-weight: bold;
            color: #e74c3c;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .candidat-item .role {
            font-size: 0.8rem;
            color: #f39c12;
            margin-top: 2px;
        }

        .candidat-item .detail {
            font-size: 0.85rem;
            color: #aaa;
            margin-top: 5px;
        }

        .candidat-actions {
            display: flex;
            gap: 5px;
            margin-top: 8px;
        }

        .candidat-action-btn {
            padding: 4px 8px;
            font-size: 0.75rem;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .candidat-action-btn.search { background: #3498db; color: white; }
        .candidat-action-btn.twitter { background: #1da1f2; color: white; }
        .candidat-action-btn.dinguerie { background: #9b59b6; color: white; }

        /* Dingueries */
        .dingueries-list {
            margin-top: 10px;
        }

        .dinguerie-item {
            background: rgba(155, 89, 182, 0.2);
            border-left: 3px solid #9b59b6;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 0 8px 8px 0;
            font-size: 0.85rem;
        }

        .dinguerie-item .quote {
            font-style: italic;
            color: #e4e4e4;
            margin-bottom: 5px;
        }

        .dinguerie-item .meta {
            font-size: 0.75rem;
            color: #888;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .dinguerie-item .source-link {
            color: #9b59b6;
            text-decoration: none;
        }

        .dinguerie-item .source-link:hover {
            text-decoration: underline;
        }

        .dinguerie-tag {
            display: inline-block;
            padding: 2px 8px;
            font-size: 0.7rem;
            border-radius: 10px;
            margin-right: 5px;
        }

        .tag-racisme { background: #e74c3c; }
        .tag-islamophobie { background: #e67e22; }
        .tag-homophobie { background: #9b59b6; }
        .tag-sexisme { background: #e91e63; }
        .tag-antisemitisme { background: #795548; }
        .tag-autre { background: #607d8b; }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: #1a1a2e;
            border-radius: 15px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 1.2rem;
        }

        .modal-close {
            background: none;
            border: none;
            color: #888;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .modal-body {
            padding: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #aaa;
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            background: rgba(255,255,255,0.05);
            color: white;
            font-size: 0.95rem;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-group select {
            cursor: pointer;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95rem;
            transition: all 0.3s;
        }

        .btn-primary { background: #1d4eff; color: white; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn-secondary { background: rgba(255,255,255,0.1); color: #e4e4e4; }

        .btn:hover {
            transform: scale(1.02);
            filter: brightness(1.1);
        }

        /* Search Panel */
        .search-panel {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .search-panel h3 {
            margin-bottom: 15px;
        }

        .search-results {
            display: grid;
            gap: 15px;
        }

        .search-result-item {
            background: rgba(255,255,255,0.05);
            padding: 15px;
            border-radius: 8px;
        }

        .search-result-item h4 {
            color: #3498db;
            margin-bottom: 5px;
        }

        .search-result-item p {
            font-size: 0.9rem;
            color: #aaa;
        }

        .search-result-item a {
            color: #1d4eff;
            text-decoration: none;
            font-size: 0.85rem;
        }

        /* Dingueries Tab */
        .dingueries-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 20px;
        }

        .dinguerie-card {
            background: rgba(155, 89, 182, 0.1);
            border: 1px solid rgba(155, 89, 182, 0.3);
            border-radius: 12px;
            padding: 20px;
        }

        .dinguerie-card .header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .dinguerie-card .author {
            font-weight: bold;
            color: #e74c3c;
        }

        .dinguerie-card .commune {
            font-size: 0.85rem;
            color: #888;
        }

        .dinguerie-card .quote {
            font-size: 1.1rem;
            font-style: italic;
            color: #e4e4e4;
            margin-bottom: 15px;
            padding: 15px;
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
        }

        .dinguerie-card .meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
            color: #888;
        }

        .delete-btn {
            background: none;
            border: none;
            color: #e74c3c;
            cursor: pointer;
            padding: 5px;
            font-size: 0.8rem;
        }

        /* Export */
        .export-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .export-card {
            background: rgba(255,255,255,0.05);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .export-card:hover {
            transform: translateY(-3px);
            background: rgba(255,255,255,0.1);
        }

        .export-card .icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .export-card h4 {
            margin-bottom: 5px;
        }

        .export-card p {
            font-size: 0.85rem;
            color: #888;
        }

        /* Iframe search */
        .iframe-container {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            height: 500px;
        }

        .iframe-container iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        .quick-search-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .quick-search-bar input {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 25px;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 1rem;
        }

        .quick-search-bar button {
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            background: #1d4eff;
            color: white;
            cursor: pointer;
            font-size: 0.95rem;
        }

        /* Legend */
        .legend {
            background: rgba(255,255,255,0.05);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .legend h3 {
            margin-bottom: 10px;
            font-size: 1rem;
        }

        .legend-items {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
        }

        .legend-color {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.8rem;
        }

        footer {
            text-align: center;
            padding: 30px;
            color: #666;
            font-size: 0.85rem;
        }

        footer a {
            color: #1d4eff;
        }

        @media (max-width: 600px) {
            .communes-grid, .dingueries-grid {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 1.4rem;
            }

            .tabs {
                flex-wrap: nowrap;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Veille Municipales 2026</h1>
        <p>Communes √† risque de basculer √† l'extr√™me droite</p>
        <div class="header-actions">
            <button class="header-btn primary" onclick="openAddDinguerieModal()">
                + Ajouter une dinguerie
            </button>
            <button class="header-btn secondary" onclick="openAddCandidatModal()">
                + Ajouter un¬∑e candidat¬∑e
            </button>
            <a href="https://municipales.streetpress.com/" target="_blank" class="header-btn success">
                Carte StreetPress
            </a>
        </div>
    </div>

    <div class="container">
        <div class="tabs">
            <button class="tab active" data-tab="communes">Communes √† risque</button>
            <button class="tab" data-tab="dingueries">Dingueries collect√©es</button>
            <button class="tab" data-tab="recherche">Recherche int√©gr√©e</button>
            <button class="tab" data-tab="export">Export & Partage</button>
        </div>

        <!-- TAB: Communes -->
        <div id="tab-communes" class="tab-content active">
            <div class="stats">
                <div class="stat-card">
                    <div class="number" id="total-communes">0</div>
                    <div class="label">Communes</div>
                </div>
                <div class="stat-card">
                    <div class="number" id="score-e">0</div>
                    <div class="label">Score E</div>
                </div>
                <div class="stat-card">
                    <div class="number" id="score-d">0</div>
                    <div class="label">Score D</div>
                </div>
                <div class="stat-card">
                    <div class="number" id="total-candidats">0</div>
                    <div class="label">Candidat¬∑es ED</div>
                </div>
                <div class="stat-card">
                    <div class="number" id="total-dingueries">0</div>
                    <div class="label">Dingueries</div>
                </div>
            </div>

            <div class="legend">
                <h3>Echelle de risque</h3>
                <div class="legend-items">
                    <div class="legend-item">
                        <div class="legend-color score-E">E</div>
                        <span>Victoire probable 1er tour</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color score-D">D</div>
                        <span>Risque √©lev√©</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color score-C">C</div>
                        <span>Risque mod√©r√©</span>
                    </div>
                </div>
            </div>

            <div class="filters">
                <button class="filter-btn active" data-score="all">Toutes</button>
                <button class="filter-btn" data-score="E">Score E</button>
                <button class="filter-btn" data-score="D">Score D</button>
                <button class="filter-btn" data-score="C">Score C</button>
                <div class="search-box">
                    <input type="text" id="search" placeholder="Rechercher une commune, un candidat...">
                </div>
            </div>

            <div class="communes-grid" id="communes-grid"></div>
        </div>

        <!-- TAB: Dingueries -->
        <div id="tab-dingueries" class="tab-content">
            <div class="filters">
                <button class="filter-btn active" data-tag="all">Toutes</button>
                <button class="filter-btn" data-tag="racisme">Racisme</button>
                <button class="filter-btn" data-tag="islamophobie">Islamophobie</button>
                <button class="filter-btn" data-tag="homophobie">Homophobie</button>
                <button class="filter-btn" data-tag="sexisme">Sexisme</button>
                <button class="filter-btn" data-tag="antisemitisme">Antis√©mitisme</button>
                <div class="search-box">
                    <input type="text" id="search-dingueries" placeholder="Rechercher dans les dingueries...">
                </div>
            </div>
            <div class="dingueries-grid" id="dingueries-grid"></div>
            <p id="no-dingueries" style="text-align: center; color: #888; padding: 40px;">
                Aucune dinguerie collect√©e. Cliquez sur "+ Ajouter une dinguerie" pour commencer.
            </p>
        </div>

        <!-- TAB: Recherche -->
        <div id="tab-recherche" class="tab-content">
            <div class="search-panel">
                <h3>Recherche rapide de d√©clarations</h3>
                <div class="quick-search-bar">
                    <input type="text" id="quick-search-input" placeholder="Nom du candidat ou de la commune...">
                    <select id="search-type">
                        <option value="all">Tout</option>
                        <option value="news">Actualit√©s</option>
                        <option value="polemique">Pol√©miques</option>
                        <option value="twitter">Twitter/X</option>
                    </select>
                    <button onclick="performSearch()">Rechercher</button>
                </div>
                <p style="color: #888; font-size: 0.85rem; margin-top: 10px;">
                    La recherche ouvrira les r√©sultats dans de nouveaux onglets pour contourner les limitations CORS.
                </p>
            </div>

            <div class="search-panel">
                <h3>Recherches sugg√©r√©es</h3>
                <div id="suggested-searches" class="search-results"></div>
            </div>

            <div class="search-panel">
                <h3>Sources utiles</h3>
                <div class="search-results">
                    <div class="search-result-item">
                        <h4>StreetPress - La bataille des municipales</h4>
                        <p>Carte interactive et articles sur les communes √† risque</p>
                        <a href="https://municipales.streetpress.com/" target="_blank">municipales.streetpress.com</a>
                    </div>
                    <div class="search-result-item">
                        <h4>Basta! - Carte des 50 villes</h4>
                        <p>Analyse des communes susceptibles de basculer</p>
                        <a href="https://basta.media/La-carte-des-cinquante-villes-qui-pourraient-basculer-extreme-droite-elections-municipales" target="_blank">basta.media</a>
                    </div>
                    <div class="search-result-item">
                        <h4>Regards Citoyens - NosD√©put√©s</h4>
                        <p>Activit√© parlementaire des d√©put√©¬∑es RN</p>
                        <a href="https://www.nosdeputes.fr/" target="_blank">nosdeputes.fr</a>
                    </div>
                    <div class="search-result-item">
                        <h4>CheckNews (Lib√©ration)</h4>
                        <p>Fact-checking et v√©rification</p>
                        <a href="https://www.liberation.fr/checknews/" target="_blank">liberation.fr/checknews</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB: Export -->
        <div id="tab-export" class="tab-content">
            <h3 style="margin-bottom: 20px;">Exporter les donn√©es</h3>
            <div class="export-options">
                <div class="export-card" onclick="exportJSON()">
                    <div class="icon">{ }</div>
                    <h4>Export JSON</h4>
                    <p>Donn√©es brutes r√©utilisables</p>
                </div>
                <div class="export-card" onclick="exportCSV()">
                    <div class="icon">üìä</div>
                    <h4>Export CSV</h4>
                    <p>Compatible Excel/Sheets</p>
                </div>
                <div class="export-card" onclick="exportMarkdown()">
                    <div class="icon">üìù</div>
                    <h4>Export Markdown</h4>
                    <p>Pour articles/documentation</p>
                </div>
                <div class="export-card" onclick="generateShareText()">
                    <div class="icon">üì±</div>
                    <h4>Texte de partage</h4>
                    <p>Pour r√©seaux sociaux</p>
                </div>
            </div>

            <div class="search-panel" style="margin-top: 30px;">
                <h3>Importer des donn√©es</h3>
                <p style="color: #888; margin-bottom: 15px;">Restaurer des donn√©es pr√©c√©demment export√©es</p>
                <input type="file" id="import-file" accept=".json" style="display: none;" onchange="importJSON(event)">
                <button class="btn btn-secondary" onclick="document.getElementById('import-file').click()">
                    Importer un fichier JSON
                </button>
            </div>

            <div id="export-preview" class="search-panel" style="margin-top: 30px; display: none;">
                <h3>Aper√ßu</h3>
                <textarea id="export-content" style="width: 100%; height: 300px; background: #0a0a15; color: #e4e4e4; border: none; border-radius: 8px; padding: 15px; font-family: monospace; font-size: 0.85rem;"></textarea>
                <div style="margin-top: 15px; display: flex; gap: 10px;">
                    <button class="btn btn-primary" onclick="downloadExport()">T√©l√©charger</button>
                    <button class="btn btn-secondary" onclick="copyExport()">Copier</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Ajouter dinguerie -->
    <div class="modal-overlay" id="modal-dinguerie">
        <div class="modal">
            <div class="modal-header">
                <h2>Ajouter une dinguerie</h2>
                <button class="modal-close" onclick="closeModal('modal-dinguerie')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="form-dinguerie" onsubmit="saveDinguerie(event)">
                    <div class="form-group">
                        <label>Auteur¬∑e de la d√©claration *</label>
                        <input type="text" id="ding-auteur" required placeholder="Pr√©nom Nom">
                    </div>
                    <div class="form-group">
                        <label>Commune</label>
                        <select id="ding-commune">
                            <option value="">-- S√©lectionner --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Citation / D√©claration *</label>
                        <textarea id="ding-citation" required placeholder="La citation exacte..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Type de propos</label>
                        <select id="ding-type">
                            <option value="racisme">Racisme</option>
                            <option value="islamophobie">Islamophobie</option>
                            <option value="homophobie">Homophobie</option>
                            <option value="sexisme">Sexisme</option>
                            <option value="antisemitisme">Antis√©mitisme</option>
                            <option value="autre">Autre</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Date (approximative)</label>
                        <input type="date" id="ding-date">
                    </div>
                    <div class="form-group">
                        <label>Source (URL) *</label>
                        <input type="url" id="ding-source" required placeholder="https://...">
                    </div>
                    <div class="form-group">
                        <label>Contexte / Notes</label>
                        <textarea id="ding-contexte" placeholder="Contexte de la d√©claration, circonstances..."></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('modal-dinguerie')">Annuler</button>
                        <button type="submit" class="btn btn-primary">Enregistrer</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal: Ajouter candidat -->
    <div class="modal-overlay" id="modal-candidat">
        <div class="modal">
            <div class="modal-header">
                <h2>Ajouter un¬∑e candidat¬∑e</h2>
                <button class="modal-close" onclick="closeModal('modal-candidat')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="form-candidat" onsubmit="saveCandidat(event)">
                    <div class="form-group">
                        <label>Commune *</label>
                        <select id="cand-commune" required>
                            <option value="">-- S√©lectionner --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Nom complet *</label>
                        <input type="text" id="cand-nom" required placeholder="Pr√©nom Nom">
                    </div>
                    <div class="form-group">
                        <label>R√¥le sur la liste</label>
                        <select id="cand-role">
                            <option value="tete">T√™te de liste</option>
                            <option value="colistier">Colistier¬∑e</option>
                            <option value="soutien">Soutien</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Parti / Mouvement</label>
                        <select id="cand-parti">
                            <option value="RN">Rassemblement National</option>
                            <option value="Reconquete">Reconqu√™te</option>
                            <option value="UDR">Union des Droites</option>
                            <option value="DLF">Debout la France</option>
                            <option value="autre">Autre / Sans √©tiquette ED</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Informations compl√©mentaires</label>
                        <textarea id="cand-detail" placeholder="Mandat actuel, historique politique..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Compte Twitter/X</label>
                        <input type="text" id="cand-twitter" placeholder="@pseudo">
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('modal-candidat')">Annuler</button>
                        <button type="submit" class="btn btn-primary">Enregistrer</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <footer>
        <p>
            Sources:
            <a href="https://www.streetpress.com/sujet/1758557171-municipales-dix-villes-pourraient-basculer-extreme-droite-electionsmunicipales2026-france" target="_blank">StreetPress</a> |
            <a href="https://basta.media/La-carte-des-cinquante-villes-qui-pourraient-basculer-extreme-droite-elections-municipales" target="_blank">Basta!</a>
        </p>
        <p style="margin-top: 10px;">App du 14 janvier 2026 - UnJourUneApp</p>
    </footer>

    <script>
        // ============ DATA ============
        let communes = [
            // SCORE E
            { id: 1, nom: "H√©nin-Beaumont", departement: "Pas-de-Calais (62)", score: "E", maireActuel: "Steeve Briois (RN)", population: "27 000", detail: "Fief historique du RN depuis 2014", candidats: [] },
            { id: 2, nom: "Perpignan", departement: "Pyr√©n√©es-Orientales (66)", score: "E", maireActuel: "Louis Aliot (RN)", population: "120 000", detail: "RN depuis 2020", candidats: [] },
            { id: 3, nom: "Fr√©jus", departement: "Var (83)", score: "E", maireActuel: "David Rachline (RN)", population: "54 000", detail: "RN depuis 2014", candidats: [] },
            { id: 4, nom: "Orange", departement: "Vaucluse (84)", score: "E", maireActuel: "Yann Bompard (RN)", population: "30 000", detail: "Historique FN/RN depuis 1995", candidats: [] },
            { id: 5, nom: "B√©ziers", departement: "H√©rault (34)", score: "E", maireActuel: "Robert M√©nard (proche RN)", population: "78 000", detail: "Robert M√©nard depuis 2014", candidats: [] },
            { id: 6, nom: "Marignane", departement: "Bouches-du-Rh√¥ne (13)", score: "E", maireActuel: "Eric Le Diss√®s (RN)", population: "34 000", detail: "RN depuis 2014", candidats: [] },
            { id: 7, nom: "Bruay-la-Buissi√®re", departement: "Pas-de-Calais (62)", score: "E", maireActuel: "Ludovic Pajot (RN)", population: "22 000", detail: "RN depuis 2020", candidats: [] },

            // SCORE D
            { id: 8, nom: "Toulon", departement: "Var (83)", score: "D", maireActuel: "Hubert Falco (DVD)", population: "180 000", detail: "Plus grande ville √† risque. Ancien fief FN (1995-2001)", candidats: [{ nom: "Laure Lavalette", role: "tete", parti: "RN", detail: "D√©put√©e RN, 49 ans", twitter: "@LaureLavalette" }] },
            { id: 9, nom: "Calais", departement: "Pas-de-Calais (62)", score: "D", maireActuel: "Natacha Bouchart (LR)", population: "73 000", detail: "Forte implantation RN dans le d√©partement", candidats: [{ nom: "Marc de Fleurian", role: "tete", parti: "RN", detail: "D√©put√© RN. Marine Le Pen √©lue dans le d√©partement", twitter: "" }] },
            { id: 10, nom: "Agde", departement: "H√©rault (34)", score: "D", maireActuel: "Vacant (d√©mission)", population: "29 000", detail: "Maire sortant mis en examen", candidats: [{ nom: "Aur√©lien Lopez-Liguori", role: "tete", parti: "RN", detail: "D√©put√© RN √©lu au 1er tour", twitter: "@ALopezLiguworry" }] },
            { id: 11, nom: "Allauch", departement: "Bouches-du-Rh√¥ne (13)", score: "D", maireActuel: "Lionel de Cala (DVD)", population: "21 000", detail: "50 ans de mairie socialiste avant bascule", candidats: [{ nom: "Christelle Varnier", role: "tete", parti: "RN", detail: "Jos√© Gonzalez (d√©put√© RN) a fait 60%+ en 2024", twitter: "" }] },
            { id: 12, nom: "Les Pennes-Mirabeau", departement: "Bouches-du-Rh√¥ne (13)", score: "D", maireActuel: "Michel Amiel (ex-PS)", population: "22 000", detail: "67,76% pour le RN aux l√©gislatives 2024", candidats: [] },
            { id: 13, nom: "Fos-sur-Mer", departement: "Bouches-du-Rh√¥ne (13)", score: "D", maireActuel: "Ren√© Raimondi (DVG)", population: "16 000", detail: "Top 5 r√©servoir de voix RN", candidats: [{ nom: "Emmanuel Fouquart", role: "tete", parti: "RN", detail: "62,78% aux l√©gislatives 2024", twitter: "" }] },
            { id: 14, nom: "Vitrolles", departement: "Bouches-du-Rh√¥ne (13)", score: "D", maireActuel: "Lo√Øc Gachon (DVG)", population: "35 000", detail: "1√®re commune FN en 1997 (M√©gret)", candidats: [] },
            { id: 15, nom: "Roquebrune-sur-Argens", departement: "Var (83)", score: "D", maireActuel: "Luc Jousse (DVD)", population: "14 000", detail: "D√©put√©e RN tr√®s implant√©e", candidats: [{ nom: "Julie Lechanteux", role: "tete", parti: "RN", detail: "D√©put√©e RN √©lue au 1er tour 2024", twitter: "@music_juls" }] },
            { id: 16, nom: "Menton", departement: "Alpes-Maritimes (06)", score: "D", maireActuel: "Yves Juhel (ne se repr√©sente pas)", population: "30 000", detail: "Opportunit√© ED, maire sortant part", candidats: [{ nom: "Alexandra Masson", role: "tete", parti: "RN", detail: "D√©put√©e RN √©lue au 1er tour 2024", twitter: "@AMasson_RN" }] },
            { id: 17, nom: "Montauban", departement: "Tarn-et-Garonne (82)", score: "D", maireActuel: "Brigitte Bar√®ges (in√©ligible)", population: "62 000", detail: "Exception dans le Sud-Ouest", candidats: [] },
            { id: 18, nom: "Li√©vin", departement: "Pas-de-Calais (62)", score: "D", maireActuel: "Laurent Duporge (PS)", population: "30 000", detail: "PS √† 73% en 2020 mais contexte chang√©", candidats: [{ nom: "Dany Paiva", role: "tete", parti: "RN", detail: "Trentenaire originaire du Gard", twitter: "" }] },
            { id: 19, nom: "Lens", departement: "Pas-de-Calais (62)", score: "D", maireActuel: "Sylvain Robert (PS)", population: "32 000", detail: "Ancien bastion PS menac√©", candidats: [{ nom: "Bruno Clavet", role: "tete", parti: "RN", detail: "D√©put√© RN, 36 ans, t√™te de liste", twitter: "" }] },
            { id: 20, nom: "Hy√®res", departement: "Var (83)", score: "D", maireActuel: "Jean-Pierre Giran (LR)", population: "56 000", detail: "Var = d√©partement le plus RN", candidats: [] },
            { id: 21, nom: "Martigues", departement: "Bouches-du-Rh√¥ne (13)", score: "D", maireActuel: "Gaby Charroux (PCF)", population: "49 000", detail: "Fief PCF menac√©", candidats: [] },
            { id: 22, nom: "Narbonne", departement: "Aude (11)", score: "D", maireActuel: "Didier Mouly (DVD)", population: "55 000", detail: "R√©gion √† forte pression RN", candidats: [] },
            { id: 23, nom: "Boulogne-sur-Mer", departement: "Pas-de-Calais (62)", score: "D", maireActuel: "Fr√©d√©ric Cuvillier (PS)", population: "41 000", detail: "Port de p√™che, th√©matiques RN", candidats: [{ nom: "Antoine Golliot", role: "tete", parti: "RN", detail: "D√©put√© RN, 40 ans", twitter: "" }] },
            { id: 24, nom: "Carpentras", departement: "Vaucluse (84)", score: "D", maireActuel: "Serge Andrieu (DVG)", population: "30 000", detail: "D√©partement historique du FN", candidats: [] },

            // SCORE C
            { id: 25, nom: "Romorantin-Lanthenay", departement: "Loir-et-Cher (41)", score: "C", maireActuel: "Jeanny Lorgeoux (PS)", population: "17 000", detail: "Territoire rural, vote RN en hausse", candidats: [] },

            // Nouvelles communes - Candidats Reconqu√™te (source: Candidator.fr)
            { id: 26, nom: "Bourg-en-Bresse", departement: "Ain (01)", score: "C", maireActuel: "Jean-Fran√ßois Debat (PS)", population: "42 000", detail: "Liste union des droites LR-Reconqu√™te annonc√©e", candidats: [{ nom: "Benoit de Boysson", role: "tete", parti: "Reconquete", detail: "T√™te de liste union des droites (LR-Reconqu√™te)", twitter: "" }] },
            { id: 27, nom: "√âvreux", departement: "Eure (27)", score: "D", maireActuel: "Guy Lefrand (LR)", population: "51 000", detail: "Candidature officielle Reconqu√™te annonc√©e. Jean Messiha figure m√©diatique du parti", candidats: [{ nom: "Jean Messiha", role: "tete", parti: "Reconquete", detail: "Candidat officiel Reconqu√™te, 55 ans, √©conomiste et figure m√©diatique", twitter: "@JeanMessiha" }] },
            { id: 28, nom: "Saint-Priest", departement: "Rh√¥ne (69)", score: "C", maireActuel: "Gilles Gascon (LR)", population: "47 000", detail: "Candidature Reconqu√™te dans la m√©tropole lyonnaise", candidats: [{ nom: "Andr√© Pozzi", role: "tete", parti: "Reconquete", detail: "Candidat Reconqu√™te", twitter: "" }] },
            { id: 29, nom: "Paris 16e", departement: "Paris (75)", score: "C", maireActuel: "Francis Szpiner (LR)", population: "166 000", detail: "Arrondissement hupp√©, candidatures Reconqu√™te et RN/UDR", candidats: [{ nom: "Sarah Knafo", role: "tete", parti: "Reconquete", detail: "Eurod√©put√©e Reconqu√™te, 32 ans, d√©fense de l'identit√© fran√ßaise", twitter: "@SarahKnaorth" }, { nom: "Thierry Mariani", role: "tete", parti: "RN", detail: "Candidat RN/UDR, 67 ans, ancien ministre", twitter: "@ThierryMARIANI" }] },

            // Candidats UDR - Union des Droites (√âric Ciotti, alli√© RN) - source: Candidator.fr
            { id: 30, nom: "Nice", departement: "Alpes-Maritimes (06)", score: "D", maireActuel: "Christian Estrosi (Horizons)", population: "342 000", detail: "Plus grande ville vis√©e par l'UDR. √âric Ciotti t√™te de liste avec Jean-Pierre Riv√®re", candidats: [{ nom: "√âric Ciotti", role: "tete", parti: "UDR", detail: "Pr√©sident de l'UDR, 59 ans, ex-LR ralli√© au RN, pr√¥ne une droite ferme sur l'autorit√©, la s√©curit√© et l'identit√©", twitter: "@eabordenave" }, { nom: "Jean-Pierre Riv√®re", role: "colistier", parti: "UDR", detail: "Ancien pr√©sident de l'OGC Nice, candidat comme 1er adjoint", twitter: "" }] },
            { id: 31, nom: "La Teste-de-Buch", departement: "Gironde (33)", score: "C", maireActuel: "Patrick Davet (DVD)", population: "28 000", detail: "Candidatures UDR et RN", candidats: [{ nom: "Marc Muret", role: "tete", parti: "UDR", detail: "Candidat pr√¥nant l'union des droites, sans investiture officielle UDR", twitter: "" }, { nom: "Yanis Ouadah", role: "tete", parti: "RN", detail: "√âtudiant, 22 ans, candidat RN", twitter: "" }] },
            { id: 32, nom: "Poitiers", departement: "Vienne (86)", score: "C", maireActuel: "L√©onore Moncond'huy (EELV)", population: "89 000", detail: "Liste Libert√© pour Poitiers sous √©tiquette UDR", candidats: [{ nom: "Marie-Dolor√®s Prost", role: "tete", parti: "UDR", detail: "Candidate sous l'√©tiquette UDR, liste 'Libert√© pour Poitiers'", twitter: "" }, { nom: "Charles Rangheard", role: "tete", parti: "RN", detail: "Ing√©nieur informatique, 33 ans, t√™te de liste RN", twitter: "" }] },

            // Candidats RN - Grandes villes (source: Candidator.fr)
            { id: 33, nom: "Marseille 13e", departement: "Bouches-du-Rh√¥ne (13)", score: "D", maireActuel: "Secteur LR", population: "90 000", detail: "Secteur populaire, d√©put√© RN candidat", candidats: [{ nom: "Franck Allisio", role: "tete", parti: "RN", detail: "D√©put√© RN, 45 ans", twitter: "" }] },
            { id: 34, nom: "Aix-en-Provence", departement: "Bouches-du-Rh√¥ne (13)", score: "C", maireActuel: "Sophie Joissains (UDI)", population: "145 000", detail: "Candidature RN officielle face √† la maire sortante", candidats: [{ nom: "Jean-Louis Geiger", role: "tete", parti: "RN", detail: "Candidat officiel RN, 55 ans", twitter: "" }] },
            { id: 35, nom: "Caen", departement: "Calvados (14)", score: "C", maireActuel: "Jo√´l Bruneau (LR)", population: "106 000", detail: "Capitale normande, candidat RN d√©sign√©", candidats: [{ nom: "Brice Desrettes", role: "tete", parti: "RN", detail: "Candidat d√©sign√© par le RN", twitter: "" }] },
            { id: 36, nom: "N√Æmes", departement: "Gard (30)", score: "D", maireActuel: "Jean-Paul Fournier (LR)", population: "151 000", detail: "Ex-maire RN Julien Sanchez candidat, fort potentiel ED", candidats: [{ nom: "Julien Sanchez", role: "tete", parti: "RN", detail: "D√©put√© europ√©en, 42 ans, ex-maire de Beaucaire (2014-2024)", twitter: "@jsanchez_RN" }] },
            { id: 37, nom: "Bagnols-sur-C√®ze", departement: "Gard (30)", score: "D", maireActuel: "Jean-Yves Chapelet (DVD)", population: "19 000", detail: "D√©put√©e RN candidate", candidats: [{ nom: "Pascale Bordes", role: "tete", parti: "RN", detail: "D√©put√©e RN, 64 ans", twitter: "" }] },
            { id: 38, nom: "Toulouse", departement: "Haute-Garonne (31)", score: "C", maireActuel: "Jean-Luc Moudenc (DVD)", population: "498 000", detail: "4e ville de France, candidature RN symbolique", candidats: [{ nom: "Julien Leonardelli", role: "tete", parti: "RN", detail: "Conseiller r√©gional, 38 ans", twitter: "" }] },
            { id: 39, nom: "Bordeaux", departement: "Gironde (33)", score: "C", maireActuel: "Pierre Hurmic (EELV)", population: "260 000", detail: "Grande m√©tropole, candidate RN", candidats: [{ nom: "Julie Rechagneux", role: "tete", parti: "RN", detail: "Candidate RN", twitter: "" }] },
            { id: 40, nom: "Arcachon", departement: "Gironde (33)", score: "C", maireActuel: "Yves Foulon (LR)", population: "12 000", detail: "Station baln√©aire, √©lu r√©gional RN/UDR candidat", candidats: [{ nom: "Laurent Lamara", role: "tete", parti: "RN", detail: "√âlu r√©gional RN/UDR", twitter: "" }] },
            { id: 41, nom: "M√©rignac", departement: "Gironde (33)", score: "C", maireActuel: "Alain Anziani (PS)", population: "74 000", detail: "Banlieue bordelaise, candidat RN", candidats: [{ nom: "Jimmy Bourlieux", role: "tete", parti: "RN", detail: "Directeur IFEL, 31 ans", twitter: "" }] },
            { id: 42, nom: "Rennes", departement: "Ille-et-Vilaine (35)", score: "C", maireActuel: "Nathalie App√©r√© (PS)", population: "222 000", detail: "Capitale bretonne, candidate RN", candidats: [{ nom: "Julien Masson", role: "tete", parti: "RN", detail: "T√™te de liste RN", twitter: "" }] },
            { id: 43, nom: "Saint-Malo", departement: "Ille-et-Vilaine (35)", score: "C", maireActuel: "Gilles Lurton (LR)", population: "46 000", detail: "Liste commune RN-UDR", candidats: [{ nom: "Thidalack Abhay", role: "tete", parti: "RN", detail: "T√™te de liste RN-UDR, 48 ans", twitter: "" }] },
            { id: 44, nom: "Tours", departement: "Indre-et-Loire (37)", score: "C", maireActuel: "Emmanuel Denis (EELV)", population: "136 000", detail: "D√©put√© europ√©en RN candidat", candidats: [{ nom: "Aleksandar Nikolic", role: "tete", parti: "RN", detail: "D√©put√© europ√©en RN, 39 ans", twitter: "" }] },
            { id: 45, nom: "Reims", departement: "Marne (51)", score: "C", maireActuel: "Arnaud Robinet (Horizons)", population: "182 000", detail: "D√©put√©e europ√©enne RN candidate", candidats: [{ nom: "Anne-Sophie Frigout", role: "tete", parti: "RN", detail: "D√©put√©e europ√©enne RN, 35 ans", twitter: "" }] },
            { id: 46, nom: "Lorient", departement: "Morbihan (56)", score: "C", maireActuel: "Fabrice Loher (DVD)", population: "57 000", detail: "Port breton, candidat RN investi", candidats: [{ nom: "Th√©o Thomas", role: "tete", parti: "RN", detail: "Candidat investi RN", twitter: "" }] },
            { id: 47, nom: "Lille", departement: "Nord (59)", score: "C", maireActuel: "Martine Aubry (PS)", population: "236 000", detail: "Grande m√©tropole du Nord, d√©put√© RN candidat", candidats: [{ nom: "Matthieu Valet", role: "tete", parti: "RN", detail: "Ancien policier, d√©put√© RN, 39 ans", twitter: "" }] },
            { id: 48, nom: "Pau", departement: "Pyr√©n√©es-Atlantiques (64)", score: "C", maireActuel: "Fran√ßois Bayrou (MoDem)", population: "77 000", detail: "Fief de Bayrou, jeune candidate RN", candidats: [{ nom: "Margaux Taillefer", role: "tete", parti: "RN", detail: "Ex-porte-parole G√©n√©ration Z, 26 ans", twitter: "" }] },
            { id: 49, nom: "Biarritz", departement: "Pyr√©n√©es-Atlantiques (64)", score: "C", maireActuel: "Maider Arosteguy (DVD)", population: "25 000", detail: "Station baln√©aire basque", candidats: [{ nom: "Michel Fournier", role: "tete", parti: "RN", detail: "T√™te de liste RN", twitter: "" }] },
            { id: 50, nom: "Strasbourg", departement: "Bas-Rhin (67)", score: "C", maireActuel: "Jeanne Barseghian (EELV)", population: "287 000", detail: "Capitale europ√©enne, candidate RN", candidats: [{ nom: "Virginie Joron", role: "tete", parti: "RN", detail: "Candidate RN", twitter: "" }] },
            { id: 51, nom: "Le Mans", departement: "Sarthe (72)", score: "C", maireActuel: "St√©phane Le Foll (PS)", population: "145 000", detail: "Candidat RN d√©sign√©", candidats: [{ nom: "Pierre Vaugarny", role: "tete", parti: "RN", detail: "Candidat d√©sign√© RN", twitter: "" }] },
            { id: 52, nom: "Le Havre", departement: "Seine-Maritime (76)", score: "D", maireActuel: "√âdouard Philippe (Horizons)", population: "170 000", detail: "Fief d'√âdouard Philippe, liste commune UDR-RN", candidats: [{ nom: "Franck Keller", role: "tete", parti: "RN", detail: "T√™te de liste UDR-RN", twitter: "" }] },
            { id: 53, nom: "Provins", departement: "Seine-et-Marne (77)", score: "D", maireActuel: "Olivier Lavenka (LR)", population: "12 000", detail: "D√©put√© RN candidat", candidats: [{ nom: "Julien Limongi", role: "tete", parti: "RN", detail: "D√©put√© RN, 29 ans", twitter: "" }] },
            { id: 54, nom: "Abbeville", departement: "Somme (80)", score: "D", maireActuel: "Pascal Demarthe (UDI)", population: "23 000", detail: "Conseill√®re r√©gionale RN candidate", candidats: [{ nom: "Nathalie Ribeiro-Billet", role: "tete", parti: "RN", detail: "Conseill√®re r√©gionale RN, 35 ans", twitter: "" }] },
            { id: 55, nom: "Limoges", departement: "Haute-Vienne (87)", score: "C", maireActuel: "√âmile-Roger Lombertie (LR)", population: "132 000", detail: "Conseiller r√©gional RN candidat", candidats: [{ nom: "Albin Freychet", role: "tete", parti: "RN", detail: "Conseiller r√©gional RN", twitter: "" }] },
            { id: 56, nom: "Auxerre", departement: "Yonne (89)", score: "C", maireActuel: "Crescent Marault (LR)", population: "35 000", detail: "Conseiller r√©gional RN candidat", candidats: [{ nom: "Pascal Blaise", role: "tete", parti: "RN", detail: "Conseiller r√©gional RN", twitter: "" }] },
            { id: 57, nom: "Ajaccio", departement: "Corse-du-Sud (20)", score: "C", maireActuel: "St√©phane Sbraggia (autonomiste)", population: "73 000", detail: "D√©l√©gu√© r√©gional RN candidat", candidats: [{ nom: "Fran√ßois Filoni", role: "tete", parti: "RN", detail: "D√©l√©gu√© r√©gional RN, 60 ans", twitter: "" }] },
            { id: 58, nom: "Bastia", departement: "Haute-Corse (20)", score: "C", maireActuel: "Pierre Savelli (autonomiste)", population: "48 000", detail: "Candidat RN soutenu", candidats: [{ nom: "Jean-Antoine Battini", role: "tete", parti: "RN", detail: "Candidat soutenu RN, 50 ans", twitter: "" }] },
            { id: 59, nom: "Gap", departement: "Hautes-Alpes (05)", score: "C", maireActuel: "Roger Didier (DVD)", population: "41 000", detail: "Pr√©fecture alpine, t√™te de liste RN", candidats: [{ nom: "Rapha√´l Leroux", role: "tete", parti: "RN", detail: "T√™te de liste RN", twitter: "" }] },
            { id: 60, nom: "Agen", departement: "Lot-et-Garonne (47)", score: "C", maireActuel: "Jean Dionis du S√©jour (UDI)", population: "34 000", detail: "Conseiller r√©gional RN candidat", candidats: [{ nom: "S√©bastien Delbosq", role: "tete", parti: "RN", detail: "Conseiller r√©gional RN, 39 ans", twitter: "" }] },
            { id: 61, nom: "Bergerac", departement: "Dordogne (24)", score: "C", maireActuel: "Jonathan Prioleaud (DVD)", population: "27 000", detail: "Jeune candidat RN", candidats: [{ nom: "Christian G√©rard", role: "tete", parti: "RN", detail: "Candidat RN, 25 ans", twitter: "" }] },
            { id: 62, nom: "Lannion", departement: "C√¥tes-d'Armor (22)", score: "C", maireActuel: "Paul Le Bihan (DVG)", population: "20 000", detail: "Plus jeune candidate RN de France", candidats: [{ nom: "Blanche Le Goffic", role: "tete", parti: "RN", detail: "Coordinatrice RNJ Bretagne, 18 ans - plus jeune candidate RN", twitter: "" }] },
            { id: 63, nom: "Limoux", departement: "Aude (11)", score: "C", maireActuel: "Claude Miqueu (DVG)", population: "11 000", detail: "T√™te de liste RN", candidats: [{ nom: "Maxime Bot", role: "tete", parti: "RN", detail: "T√™te de liste RN", twitter: "" }] },
            { id: 64, nom: "Cognac", departement: "Charente (16)", score: "C", maireActuel: "Michel Gourinchas (PS)", population: "19 000", detail: "T√™te de liste RN", candidats: [{ nom: "Adrien Hoffmann", role: "tete", parti: "RN", detail: "T√™te de liste RN", twitter: "" }] },
            { id: 65, nom: "Mont-de-Marsan", departement: "Landes (40)", score: "C", maireActuel: "Charles Dayot (LR)", population: "32 000", detail: "Candidat RN d√©sign√©", candidats: [{ nom: "Nicolas Leregle", role: "tete", parti: "RN", detail: "Candidat d√©sign√© RN", twitter: "" }] }
        ];

        // Base de donn√©es pr√©-remplie avec des dingueries document√©es et sourc√©es
        let dingueriesPreRemplies = [
            {
                auteur: "Daniel Grenon",
                communeId: null,
                circonscription: "Yonne (89)",
                citation: "Les Maghr√©bins ne devraient pas se trouver dans les positions √©lev√©es",
                type: "racisme",
                date: "2024-07",
                source: "https://42mag.fr/2025/05/condamnation-de-11-000e-pour-propos-racistes-daniel-grenon-ex-rn-depute-de-lyonne/",
                contexte: "Lors d'un d√©bat l√©gislatif. Condamn√© √† 11 000‚Ç¨ d'amende en mai 2025. Exclu du RN en octobre 2024.",
                condamnation: true
            },
            {
                auteur: "Gilles Bourdouleix",
                communeId: null,
                circonscription: "Maine-et-Loire (49)",
                citation: "Hitler n'en a peut-√™tre pas tu√© assez",
                type: "racisme",
                date: "2013-07",
                source: "https://www.streetpress.com/",
                contexte: "Propos visant les gens du voyage. Alli√© RN aux municipales.",
                condamnation: false
            },
            {
                auteur: "Fr√©d√©ric Boccaletti",
                communeId: null,
                circonscription: "Var (83)",
                citation: "Violence en r√©union avec arme contre des jeunes noirs",
                type: "racisme",
                date: "2000",
                source: "https://www.streetpress.com/",
                contexte: "Condamn√© √† 1 an de prison. D√©put√© RN sortant. Fondateur de la librairie d'extr√™me droite 'Anthin√©a' (r√©f√©rence √† Maurras).",
                condamnation: true
            },
            {
                auteur: "Sophie Dumont",
                communeId: null,
                circonscription: "C√¥te-d'Or (21)",
                citation: "Le petit geste qui trahit l'origine des fonds qui alimentent Reconqu√™te",
                type: "antisemitisme",
                date: "2024",
                source: "https://www.liberation.fr/",
                contexte: "Insinuation antis√©mite visant Sarah Knafo. √âgalement complotiste (Brigitte Macron serait un homme).",
                condamnation: false
            },
            {
                auteur: "Marie-Christine Sorin",
                communeId: null,
                circonscription: "Hautes-Pyr√©n√©es (65)",
                citation: "Civilisations n'ayant aucun humanisme rest√©es au-dessous de la bestialit√©",
                type: "racisme",
                date: "2024",
                source: "https://www.liberation.fr/",
                contexte: "Propos supr√©macistes publi√©s sur Twitter.",
                condamnation: false
            },
            {
                auteur: "Caroline Parmentier",
                communeId: null,
                circonscription: "Pas-de-Calais (62)",
                citation: "Avortement g√©nocide fran√ßais remplac√©s par migrants",
                type: "autre",
                date: "2018-05",
                source: "https://basta.media/racistes-homophobes-complotistes-pro-poutine-antisemites-candidats-rn",
                contexte: "D√©fense du 'grand remplacement' dans le journal Pr√©sent.",
                condamnation: false
            },
            {
                auteur: "Louis-Joseph Gannat Peche",
                communeId: null,
                circonscription: "Meurthe-et-Moselle (54)",
                citation: "Juif qui parle bouche qui ment",
                type: "antisemitisme",
                date: "2024",
                source: "https://www.streetpress.com/",
                contexte: "Tweet antis√©mite. A aussi insult√© Franck Riester pour son homosexualit√©.",
                condamnation: false
            },
            {
                auteur: "Pierre-Nicolas Nups",
                communeId: null,
                circonscription: "Meurthe-et-Moselle (54)",
                citation: "On va casser du PD",
                type: "homophobie",
                date: "2013-05",
                source: "https://tetu.com/",
                contexte: "Vid√©o appelant √† la violence homophobe. Ancien membre du GUD.",
                condamnation: false
            },
            {
                auteur: "Herv√© de L√©pinau",
                communeId: 24,
                circonscription: "Vaucluse (84)",
                citation: "IVG assimil√©e aux g√©nocides arm√©nien, rwandais, √† la Shoah et Daesh",
                type: "autre",
                date: "2020-10",
                source: "https://www.lejdd.fr/",
                contexte: "Opposition radicale √† l'IVG. D√©put√© de Carpentras.",
                condamnation: false
            },
            {
                auteur: "Joseph Martin",
                communeId: null,
                circonscription: "Morbihan (56)",
                citation: "Le gaz a rendu justice aux victimes de la Shoah",
                type: "antisemitisme",
                date: "2018-10",
                source: "https://fr.timesofisrael.com/les-candidats-du-rn-qui-font-tache-leurs-propos-antisemites-racistes-et-complotistes/",
                contexte: "Tweet concernant la mort de Robert Faurisson. R√©investi malgr√© la pol√©mique.",
                condamnation: false
            },
            {
                auteur: "Fran√ßoise Billaud",
                communeId: null,
                circonscription: "C√¥tes-d'Armor (22)",
                citation: "Hommage √† Philippe P√©tain et l'abb√© Perrot (figure de la collaboration)",
                type: "autre",
                date: "2024-05",
                source: "https://fr.timesofisrael.com/",
                contexte: "Partages Facebook pro-Vichy. Aussi homophobe (soutenir 'l'h√©t√©rosexualit√© pendant qu'elle est encore l√©gale').",
                condamnation: false
            },
            {
                auteur: "Agn√®s Pageard",
                communeId: null,
                circonscription: "Paris (75)",
                citation: "Invitait √† relire Henry Coston (collaborateur antis√©mite 1910-2001)",
                type: "antisemitisme",
                date: "2021-02",
                source: "https://fr.timesofisrael.com/",
                contexte: "A promu Cassandre Fristot, condamn√©e en 2021 pour gestes antis√©mites.",
                condamnation: false
            },
            {
                auteur: "Paule Veyre de Soras",
                communeId: null,
                circonscription: "Mayenne (53)",
                citation: "J'ai comme ophtalmo un juif. Et j'ai comme dentiste un musulman",
                type: "racisme",
                date: "2024-06",
                source: "https://www.franceinfo.fr/",
                contexte: "R√©ponse aux accusations de racisme du RN lors d'un d√©bat l√©gislatives 2024.",
                condamnation: false
            },
            {
                auteur: "Rody Tolassy",
                communeId: null,
                circonscription: "Guadeloupe (971)",
                citation: "Violence film√©e contre une opposante politique",
                type: "autre",
                date: "2022-03",
                source: "https://www.politis.fr/",
                contexte: "Film√© frappant une femme. Candidat RN.",
                condamnation: false
            }
        ];

        let dingueries = [];
        let currentExportData = null;
        let currentExportType = null;

        // Load from localStorage
        function loadData() {
            const savedCandidats = localStorage.getItem('municipales_candidats');
            const savedDingueries = localStorage.getItem('municipales_dingueries');

            if (savedCandidats) {
                const candidatsData = JSON.parse(savedCandidats);
                candidatsData.forEach(c => {
                    const commune = communes.find(comm => comm.id === c.communeId);
                    if (commune) {
                        commune.candidats.push(c);
                    }
                });
            }

            // Charger les dingueries pr√©-remplies + celles de l'utilisateur
            dingueries = [...dingueriesPreRemplies];

            if (savedDingueries) {
                const userDingueries = JSON.parse(savedDingueries);
                // Ajouter les dingueries utilisateur qui ne sont pas des doublons
                userDingueries.forEach(ud => {
                    if (!dingueries.find(d => d.citation === ud.citation && d.auteur === ud.auteur)) {
                        dingueries.push(ud);
                    }
                });
            }
        }

        function saveData() {
            // Flatten all candidats with their communeId
            const allCandidats = [];
            communes.forEach(c => {
                c.candidats.forEach(cand => {
                    if (cand.custom) {
                        allCandidats.push({ ...cand, communeId: c.id });
                    }
                });
            });
            localStorage.setItem('municipales_candidats', JSON.stringify(allCandidats));
            localStorage.setItem('municipales_dingueries', JSON.stringify(dingueries));
        }

        // ============ RENDERING ============
        function renderCommunes() {
            const grid = document.getElementById('communes-grid');
            grid.innerHTML = '';

            communes.forEach(commune => {
                const card = document.createElement('div');
                card.className = 'commune-card';
                card.dataset.score = commune.score;
                card.dataset.search = `${commune.nom} ${commune.departement} ${commune.candidats.map(c => c.nom).join(' ')}`.toLowerCase();

                const communeDingueries = dingueries.filter(d => d.communeId === commune.id);

                card.innerHTML = `
                    <div class="commune-header" onclick="toggleCommune(${commune.id})">
                        <div>
                            <div class="commune-name">${commune.nom}</div>
                            <div class="commune-dept">${commune.departement}</div>
                        </div>
                        <div class="score-badge score-${commune.score}">${commune.score}</div>
                    </div>
                    <div class="commune-body">
                        <div class="info-row">
                            <span class="info-label">Population</span>
                            <span class="info-value">${commune.population} hab.</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Maire actuel</span>
                            <span class="info-value">${commune.maireActuel}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Contexte</span>
                            <span class="info-value">${commune.detail}</span>
                        </div>

                        <div class="candidats-section">
                            <h4>
                                Candidat¬∑es ED (${commune.candidats.length})
                                <button class="add-candidat-btn" onclick="openAddCandidatModal(${commune.id})">+ Ajouter</button>
                            </h4>
                            ${commune.candidats.length === 0 ? '<p style="color: #888; font-size: 0.85rem;">Aucun¬∑e candidat¬∑e identifi√©¬∑e</p>' : ''}
                            ${commune.candidats.map((c, idx) => `
                                <div class="candidat-item">
                                    <div class="name">
                                        ${c.nom}
                                        ${c.custom ? `<button class="delete-btn" onclick="deleteCandidat(${commune.id}, ${idx})">Supprimer</button>` : ''}
                                    </div>
                                    <div class="role">${getRoleLabel(c.role)} - ${c.parti}</div>
                                    <div class="detail">${c.detail}</div>
                                    <div class="candidat-actions">
                                        <button class="candidat-action-btn search" onclick="searchCandidat('${c.nom}')">Rechercher</button>
                                        ${c.twitter ? `<button class="candidat-action-btn twitter" onclick="window.open('https://x.com/${c.twitter.replace('@','')}', '_blank')">Twitter</button>` : `<button class="candidat-action-btn twitter" onclick="window.open('https://x.com/search?q=${encodeURIComponent(c.nom)}', '_blank')">Chercher X</button>`}
                                        <button class="candidat-action-btn dinguerie" onclick="openAddDinguerieModal(${commune.id}, '${c.nom}')">+ Dinguerie</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>

                        ${communeDingueries.length > 0 ? `
                        <div class="dingueries-list">
                            <h4 style="color: #9b59b6; margin: 15px 0 10px;">Dingueries (${communeDingueries.length})</h4>
                            ${communeDingueries.slice(0, 3).map(d => `
                                <div class="dinguerie-item">
                                    <span class="dinguerie-tag tag-${d.type}">${d.type}</span>
                                    <div class="quote">"${truncate(d.citation, 100)}"</div>
                                    <div class="meta">
                                        <span>${d.auteur}</span>
                                        <a href="${d.source}" target="_blank" class="source-link">Source</a>
                                    </div>
                                </div>
                            `).join('')}
                            ${communeDingueries.length > 3 ? `<p style="color: #888; font-size: 0.8rem; text-align: center;">+ ${communeDingueries.length - 3} autres</p>` : ''}
                        </div>
                        ` : ''}
                    </div>
                `;

                grid.appendChild(card);
            });

            updateStats();
        }

        function renderDingueries() {
            const grid = document.getElementById('dingueries-grid');
            const noMsg = document.getElementById('no-dingueries');

            if (dingueries.length === 0) {
                grid.innerHTML = '';
                noMsg.style.display = 'block';
                return;
            }

            noMsg.style.display = 'none';
            grid.innerHTML = dingueries.map((d, idx) => {
                const commune = communes.find(c => c.id === d.communeId);
                const localisation = commune ? `${commune.nom} (${commune.departement})` : (d.circonscription || 'Non sp√©cifi√©e');
                return `
                    <div class="dinguerie-card" data-tag="${d.type}" data-search="${d.auteur} ${d.citation} ${localisation}".toLowerCase()>
                        <div class="header">
                            <div>
                                <div class="author">${d.auteur} ${d.condamnation ? '<span style="background:#e74c3c;color:white;padding:2px 6px;border-radius:8px;font-size:0.7rem;margin-left:5px;">CONDAMNE</span>' : ''}</div>
                                <div class="commune">${localisation}</div>
                            </div>
                            <div>
                                <span class="dinguerie-tag tag-${d.type}">${d.type}</span>
                                ${!d.condamnation && idx >= dingueriesPreRemplies.length ? `<button class="delete-btn" onclick="deleteDinguerie(${idx})">Supprimer</button>` : ''}
                            </div>
                        </div>
                        <div class="quote">"${d.citation}"</div>
                        ${d.contexte ? `<p style="font-size: 0.85rem; color: #888; margin-bottom: 15px;">${d.contexte}</p>` : ''}
                        <div class="meta">
                            <span>${d.date || 'Date inconnue'}</span>
                            <a href="${d.source}" target="_blank" style="color: #9b59b6;">Voir la source</a>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderSuggestedSearches() {
            const container = document.getElementById('suggested-searches');
            const candidatsWithNames = [];

            communes.forEach(c => {
                c.candidats.forEach(cand => {
                    candidatsWithNames.push({ ...cand, commune: c.nom });
                });
            });

            container.innerHTML = candidatsWithNames.slice(0, 10).map(c => `
                <div class="search-result-item">
                    <h4>${c.nom}</h4>
                    <p>${c.commune} - ${c.parti}</p>
                    <div style="margin-top: 10px; display: flex; gap: 8px; flex-wrap: wrap;">
                        <a href="https://www.google.com/search?q=${encodeURIComponent(c.nom + ' RN d√©claration pol√©mique')}&tbm=nws" target="_blank" style="padding: 4px 10px; background: #4285f4; color: white; border-radius: 12px; font-size: 0.8rem; text-decoration: none;">Actualit√©s</a>
                        <a href="https://www.google.com/search?q=${encodeURIComponent(c.nom + ' racisme OR islamophobie OR condamnation')}" target="_blank" style="padding: 4px 10px; background: #e74c3c; color: white; border-radius: 12px; font-size: 0.8rem; text-decoration: none;">Pol√©miques</a>
                        <a href="https://x.com/search?q=${encodeURIComponent(c.nom)}&f=live" target="_blank" style="padding: 4px 10px; background: #1da1f2; color: white; border-radius: 12px; font-size: 0.8rem; text-decoration: none;">Twitter/X</a>
                    </div>
                </div>
            `).join('');
        }

        function updateStats() {
            document.getElementById('total-communes').textContent = communes.length;
            document.getElementById('score-e').textContent = communes.filter(c => c.score === 'E').length;
            document.getElementById('score-d').textContent = communes.filter(c => c.score === 'D').length;
            document.getElementById('total-candidats').textContent = communes.reduce((acc, c) => acc + c.candidats.length, 0);
            document.getElementById('total-dingueries').textContent = dingueries.length;
        }

        // ============ HELPERS ============
        function truncate(str, len) {
            return str.length > len ? str.substring(0, len) + '...' : str;
        }

        function getRoleLabel(role) {
            const labels = { tete: 'T√™te de liste', colistier: 'Colistier¬∑e', soutien: 'Soutien' };
            return labels[role] || role;
        }

        function populateCommuneSelects() {
            const selects = ['ding-commune', 'cand-commune'];
            selects.forEach(id => {
                const select = document.getElementById(id);
                if (!select) return;
                select.innerHTML = '<option value="">-- S√©lectionner --</option>' +
                    communes.map(c => `<option value="${c.id}">${c.nom} (${c.departement.split(' ')[0]})</option>`).join('');
            });
        }

        // ============ MODALS ============
        function openAddDinguerieModal(communeId = null, auteur = '') {
            document.getElementById('form-dinguerie').reset();
            if (communeId) document.getElementById('ding-commune').value = communeId;
            if (auteur) document.getElementById('ding-auteur').value = auteur;
            document.getElementById('modal-dinguerie').classList.add('active');
        }

        function openAddCandidatModal(communeId = null) {
            document.getElementById('form-candidat').reset();
            if (communeId) document.getElementById('cand-commune').value = communeId;
            document.getElementById('modal-candidat').classList.add('active');
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        // ============ CRUD ============
        function saveDinguerie(e) {
            e.preventDefault();
            const dinguerie = {
                auteur: document.getElementById('ding-auteur').value,
                communeId: parseInt(document.getElementById('ding-commune').value) || null,
                citation: document.getElementById('ding-citation').value,
                type: document.getElementById('ding-type').value,
                date: document.getElementById('ding-date').value,
                source: document.getElementById('ding-source').value,
                contexte: document.getElementById('ding-contexte').value,
                createdAt: new Date().toISOString()
            };
            dingueries.push(dinguerie);
            saveData();
            closeModal('modal-dinguerie');
            renderCommunes();
            renderDingueries();
        }

        function saveCandidat(e) {
            e.preventDefault();
            const communeId = parseInt(document.getElementById('cand-commune').value);
            const candidat = {
                nom: document.getElementById('cand-nom').value,
                role: document.getElementById('cand-role').value,
                parti: document.getElementById('cand-parti').value,
                detail: document.getElementById('cand-detail').value,
                twitter: document.getElementById('cand-twitter').value,
                custom: true
            };
            const commune = communes.find(c => c.id === communeId);
            if (commune) {
                commune.candidats.push(candidat);
                saveData();
                closeModal('modal-candidat');
                renderCommunes();
                renderSuggestedSearches();
            }
        }

        function deleteCandidat(communeId, idx) {
            if (!confirm('Supprimer ce¬∑tte candidat¬∑e ?')) return;
            const commune = communes.find(c => c.id === communeId);
            if (commune) {
                commune.candidats.splice(idx, 1);
                saveData();
                renderCommunes();
            }
        }

        function deleteDinguerie(idx) {
            if (!confirm('Supprimer cette dinguerie ?')) return;
            dingueries.splice(idx, 1);
            saveData();
            renderCommunes();
            renderDingueries();
        }

        // ============ SEARCH ============
        function searchCandidat(name) {
            const query = encodeURIComponent(name + ' RN d√©claration');
            window.open(`https://www.google.com/search?q=${query}&tbm=nws`, '_blank');
        }

        function performSearch() {
            const query = document.getElementById('quick-search-input').value;
            const type = document.getElementById('search-type').value;

            if (!query.trim()) return;

            let url;
            switch (type) {
                case 'news':
                    url = `https://www.google.com/search?q=${encodeURIComponent(query + ' municipales 2026')}&tbm=nws`;
                    break;
                case 'polemique':
                    url = `https://www.google.com/search?q=${encodeURIComponent(query + ' pol√©mique OR racisme OR condamnation')}`;
                    break;
                case 'twitter':
                    url = `https://x.com/search?q=${encodeURIComponent(query)}&f=live`;
                    break;
                default:
                    url = `https://www.google.com/search?q=${encodeURIComponent(query + ' extr√™me droite municipales')}`;
            }
            window.open(url, '_blank');
        }

        // ============ TABS ============
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
            });
        });

        // ============ FILTERS ============
        document.querySelectorAll('#tab-communes .filter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('#tab-communes .filter-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                const score = btn.dataset.score;
                document.querySelectorAll('.commune-card').forEach(card => {
                    card.style.display = (score === 'all' || card.dataset.score === score) ? 'block' : 'none';
                });
            });
        });

        document.getElementById('search').addEventListener('input', (e) => {
            const q = e.target.value.toLowerCase();
            document.querySelectorAll('.commune-card').forEach(card => {
                card.style.display = card.dataset.search.includes(q) ? 'block' : 'none';
            });
        });

        document.querySelectorAll('#tab-dingueries .filter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('#tab-dingueries .filter-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                const tag = btn.dataset.tag;
                document.querySelectorAll('.dinguerie-card').forEach(card => {
                    card.style.display = (tag === 'all' || card.dataset.tag === tag) ? 'block' : 'none';
                });
            });
        });

        // ============ EXPORT ============
        function exportJSON() {
            const data = {
                exportDate: new Date().toISOString(),
                communes: communes,
                dingueries: dingueries
            };
            currentExportData = JSON.stringify(data, null, 2);
            currentExportType = 'json';
            showExportPreview();
        }

        function exportCSV() {
            let csv = 'Commune,D√©partement,Score,Population,Maire,Candidat ED,Parti,Nb Dingueries\n';
            communes.forEach(c => {
                const nbDing = dingueries.filter(d => d.communeId === c.id).length;
                if (c.candidats.length === 0) {
                    csv += `"${c.nom}","${c.departement}","${c.score}","${c.population}","${c.maireActuel}","","","${nbDing}"\n`;
                } else {
                    c.candidats.forEach(cand => {
                        csv += `"${c.nom}","${c.departement}","${c.score}","${c.population}","${c.maireActuel}","${cand.nom}","${cand.parti}","${nbDing}"\n`;
                    });
                }
            });
            currentExportData = csv;
            currentExportType = 'csv';
            showExportPreview();
        }

        function exportMarkdown() {
            let md = `# Veille Municipales 2026 - Communes √† risque ED\n\n`;
            md += `*Export du ${new Date().toLocaleDateString('fr-FR')}*\n\n`;
            md += `## Statistiques\n`;
            md += `- **${communes.length}** communes surveill√©es\n`;
            md += `- **${communes.reduce((a,c) => a + c.candidats.length, 0)}** candidat¬∑es ED identifi√©¬∑es\n`;
            md += `- **${dingueries.length}** dingueries document√©es\n\n`;

            ['E', 'D', 'C'].forEach(score => {
                const filtered = communes.filter(c => c.score === score);
                if (filtered.length === 0) return;
                md += `## Score ${score}\n\n`;
                filtered.forEach(c => {
                    md += `### ${c.nom} (${c.departement})\n`;
                    md += `- **Population:** ${c.population}\n`;
                    md += `- **Maire:** ${c.maireActuel}\n`;
                    md += `- **Contexte:** ${c.detail}\n`;
                    if (c.candidats.length > 0) {
                        md += `- **Candidat¬∑es ED:**\n`;
                        c.candidats.forEach(cand => {
                            md += `  - ${cand.nom} (${cand.parti}) - ${cand.detail}\n`;
                        });
                    }
                    const dings = dingueries.filter(d => d.communeId === c.id);
                    if (dings.length > 0) {
                        md += `- **Dingueries document√©es:**\n`;
                        dings.forEach(d => {
                            md += `  - "${d.citation.substring(0, 80)}..." - ${d.auteur} ([source](${d.source}))\n`;
                        });
                    }
                    md += '\n';
                });
            });

            currentExportData = md;
            currentExportType = 'md';
            showExportPreview();
        }

        function generateShareText() {
            const scoreD = communes.filter(c => c.score === 'D');
            let text = `üó≥Ô∏è Municipales 2026 : ${scoreD.length} communes √† risque √©lev√© de basculer √† l'extr√™me droite\n\n`;
            text += `Parmi elles : ${scoreD.slice(0, 5).map(c => c.nom).join(', ')}...\n\n`;
            text += `${dingueries.length} d√©clarations probl√©matiques document√©es.\n\n`;
            text += `Plus d'infos : municipales.streetpress.com`;

            currentExportData = text;
            currentExportType = 'txt';
            showExportPreview();
        }

        function showExportPreview() {
            document.getElementById('export-preview').style.display = 'block';
            document.getElementById('export-content').value = currentExportData;
        }

        function downloadExport() {
            const blob = new Blob([currentExportData], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `veille-municipales-2026.${currentExportType}`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function copyExport() {
            navigator.clipboard.writeText(currentExportData);
            alert('Copi√© dans le presse-papier !');
        }

        function importJSON(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const data = JSON.parse(event.target.result);
                    if (data.dingueries) {
                        dingueries = data.dingueries;
                    }
                    if (data.communes) {
                        // Merge custom candidats
                        data.communes.forEach(imported => {
                            const local = communes.find(c => c.id === imported.id);
                            if (local && imported.candidats) {
                                imported.candidats.forEach(cand => {
                                    if (cand.custom && !local.candidats.find(c => c.nom === cand.nom)) {
                                        local.candidats.push(cand);
                                    }
                                });
                            }
                        });
                    }
                    saveData();
                    renderCommunes();
                    renderDingueries();
                    alert('Import r√©ussi !');
                } catch (err) {
                    alert('Erreur lors de l\'import : ' + err.message);
                }
            };
            reader.readAsText(file);
        }

        // ============ SUPABASE ============
        const SUPABASE_URL = 'https://hwunkojdzodcutewkfet.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh3dW5rb2pkem9kY3V0ZXdrZmV0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgzOTMzNTAsImV4cCI6MjA4Mzk2OTM1MH0.Zpe-QqzKDIpx3pTa6_e9ysfI-Rprl3SXANM8b2pqXU0';

        const supabaseHeaders = {
            'apikey': SUPABASE_KEY,
            'Authorization': `Bearer ${SUPABASE_KEY}`,
            'Content-Type': 'application/json',
            'Prefer': 'return=representation'
        };

        let useSupabase = true; // Toggle pour activer/d√©sactiver Supabase

        // Charger les donn√©es depuis Supabase
        async function loadFromSupabase() {
            try {
                console.log('Chargement depuis Supabase...');

                // Charger les communes
                const communesRes = await fetch(`${SUPABASE_URL}/rest/v1/communes?select=*&order=score.asc,nom.asc`, {
                    headers: supabaseHeaders
                });

                if (communesRes.ok) {
                    const communesDB = await communesRes.json();
                    if (communesDB.length > 0) {
                        // Mapper les donn√©es Supabase vers le format local
                        communes = communesDB.map(c => ({
                            id: c.id,
                            nom: c.nom,
                            departement: `${c.departement} (${c.code_dept || ''})`,
                            score: c.score,
                            maireActuel: c.maire_actuel,
                            population: c.population,
                            detail: c.detail,
                            candidats: []
                        }));
                        console.log(`  ${communes.length} communes charg√©es`);
                    }
                }

                // Charger les candidats
                const candidatsRes = await fetch(`${SUPABASE_URL}/rest/v1/candidats?select=*`, {
                    headers: supabaseHeaders
                });

                if (candidatsRes.ok) {
                    const candidatsDB = await candidatsRes.json();
                    candidatsDB.forEach(c => {
                        const commune = communes.find(comm => comm.id === c.commune_id);
                        if (commune) {
                            commune.candidats.push({
                                nom: `${c.prenom || ''} ${c.nom}`.trim(),
                                role: c.role,
                                parti: c.parti,
                                detail: c.detail,
                                twitter: c.twitter,
                                fromDB: true
                            });
                        }
                    });
                    console.log(`  ${candidatsDB.length} candidats charg√©s`);
                }

                // Charger les dingueries
                const dingueriesRes = await fetch(`${SUPABASE_URL}/rest/v1/dingueries?select=*&order=created_at.desc`, {
                    headers: supabaseHeaders
                });

                if (dingueriesRes.ok) {
                    const dingueriesDB = await dingueriesRes.json();
                    if (dingueriesDB.length > 0) {
                        dingueries = dingueriesDB.map(d => ({
                            id: d.id,
                            auteur: d.auteur,
                            communeId: d.commune_id,
                            citation: d.citation,
                            type: d.type,
                            date: d.date_declaration,
                            source: d.source_url,
                            contexte: d.contexte,
                            condamnation: d.est_condamnation,
                            montant: d.montant_condamnation,
                            fromDB: true
                        }));
                        console.log(`  ${dingueries.length} dingueries charg√©es`);
                    }
                }

                return true;
            } catch (error) {
                console.error('Erreur Supabase:', error);
                return false;
            }
        }

        // Sauvegarder une dinguerie dans Supabase
        async function saveToSupabase(table, data) {
            if (!useSupabase) return null;

            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/${table}`, {
                    method: 'POST',
                    headers: supabaseHeaders,
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    return await response.json();
                }
                console.error('Erreur sauvegarde:', await response.text());
                return null;
            } catch (error) {
                console.error('Erreur Supabase:', error);
                return null;
            }
        }

        // Modifier saveDinguerie pour sauvegarder dans Supabase
        const originalSaveDinguerie = saveDinguerie;
        saveDinguerie = async function(e) {
            e.preventDefault();

            const dinguerie = {
                auteur: document.getElementById('ding-auteur').value,
                commune_id: parseInt(document.getElementById('ding-commune').value) || null,
                citation: document.getElementById('ding-citation').value,
                type: document.getElementById('ding-type').value,
                date_declaration: document.getElementById('ding-date').value || null,
                source_url: document.getElementById('ding-source').value,
                contexte: document.getElementById('ding-contexte').value
            };

            // Sauvegarder dans Supabase
            const saved = await saveToSupabase('dingueries', dinguerie);

            if (saved && saved[0]) {
                dingueries.push({
                    id: saved[0].id,
                    auteur: dinguerie.auteur,
                    communeId: dinguerie.commune_id,
                    citation: dinguerie.citation,
                    type: dinguerie.type,
                    date: dinguerie.date_declaration,
                    source: dinguerie.source_url,
                    contexte: dinguerie.contexte,
                    fromDB: true
                });
            } else {
                // Fallback localStorage
                dingueries.push({
                    auteur: dinguerie.auteur,
                    communeId: dinguerie.commune_id,
                    citation: dinguerie.citation,
                    type: dinguerie.type,
                    date: dinguerie.date_declaration,
                    source: dinguerie.source_url,
                    contexte: dinguerie.contexte
                });
                saveData();
            }

            closeModal('modal-dinguerie');
            renderCommunes();
            renderDingueries();
        };

        // Indicateur de connexion Supabase
        function showSupabaseStatus(connected) {
            const header = document.querySelector('.header p');
            if (header) {
                header.innerHTML = `Communes √† risque de basculer √† l'extr√™me droite ${connected ? '<span style="color:#27ae60;font-size:0.8rem;">‚óè Supabase connect√©</span>' : '<span style="color:#e74c3c;font-size:0.8rem;">‚óè Mode local</span>'}`;
            }
        }

        // ============ INIT ============
        document.addEventListener('DOMContentLoaded', async () => {
            // Essayer de charger depuis Supabase d'abord
            const supabaseLoaded = await loadFromSupabase();

            if (!supabaseLoaded || communes.length === 0) {
                // Fallback sur les donn√©es locales
                console.log('Fallback sur donn√©es locales...');
                loadData();
                useSupabase = false;
            }

            showSupabaseStatus(supabaseLoaded && communes.length > 0);
            populateCommuneSelects();
            renderCommunes();
            renderDingueries();
            renderSuggestedSearches();
        });

        // Close modals on overlay click
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.classList.remove('active');
                }
            });
        });
    </script>
</body>
</html>
