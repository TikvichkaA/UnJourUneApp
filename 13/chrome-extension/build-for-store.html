<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>SecondMain - Build pour Chrome Web Store</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, sans-serif; background: #f8fafc; padding: 40px 20px; }
    .container { max-width: 700px; margin: 0 auto; }
    h1 { text-align: center; color: #10b981; margin-bottom: 8px; }
    .subtitle { text-align: center; color: #64748b; margin-bottom: 40px; }
    .card { background: white; border-radius: 12px; padding: 24px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
    .card h2 { font-size: 18px; margin-bottom: 16px; display: flex; align-items: center; gap: 10px; }
    .card h2 .num { background: #10b981; color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; }
    .icons-preview { display: flex; gap: 16px; align-items: center; margin: 16px 0; }
    .icons-preview canvas { border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    .btn { display: inline-flex; align-items: center; gap: 8px; background: #10b981; color: white; border: none; padding: 14px 28px; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; }
    .btn:hover { background: #059669; }
    .btn:disabled { background: #94a3b8; cursor: not-allowed; }
    .status { margin-top: 16px; padding: 12px; background: #f0fdf4; border-radius: 8px; color: #059669; display: none; }
    .status.show { display: block; }
    textarea { width: 100%; height: 120px; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 13px; margin-top: 8px; }
    .copy-btn { background: #e2e8f0; color: #64748b; padding: 6px 12px; font-size: 12px; margin-top: 8px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>‚ôªÔ∏è SecondMain</h1>
    <p class="subtitle">Generateur de package Chrome Web Store</p>

    <div class="card">
      <h2><span class="num">1</span> Generer le ZIP</h2>
      <p style="color: #64748b; margin-bottom: 16px;">Clique pour generer le ZIP pret a uploader.</p>
      <div class="icons-preview" id="icons-preview"></div>
      <button class="btn" id="generate-btn" onclick="generateZip()">üì¶ Generer SecondMain.zip</button>
      <div class="status" id="status"></div>
    </div>

    <div class="card">
      <h2><span class="num">2</span> Description pour le Store</h2>
      <textarea id="description" readonly>‚ôªÔ∏è SecondMain - Trouve moins cher en seconde main !

Tu fais du shopping sur Leroy Merlin, IKEA, Amazon ou Fnac ? SecondMain detecte automatiquement les produits et cherche s'ils existent en occasion sur Le Bon Coin, Vinted et autres.

üîç FONCTIONNALITES
‚Ä¢ Detection automatique du produit sur la page
‚Ä¢ Recherche en arriere-plan sur les sites d'occasion
‚Ä¢ Notification si une bonne affaire est trouvee
‚Ä¢ Liens directs vers Le Bon Coin, Vinted, Facebook Marketplace, eBay

üõí SITES SUPPORTES
Leroy Merlin, Castorama, IKEA, Amazon, Fnac, Darty, Boulanger, Cdiscount, ManoMano

üí∞ ECONOMISE ET RECYCLE
Donne une seconde vie aux produits !

üîí Aucune donnee personnelle collectee.</textarea>
      <button class="btn copy-btn" onclick="copyText('description')">Copier</button>
    </div>

    <div class="card">
      <h2><span class="num">3</span> Privacy Policy (si demande)</h2>
      <textarea id="privacy" readonly>Privacy Policy for SecondMain

SecondMain does NOT collect any personal data. All processing happens locally in your browser. We do not track users or store any information on external servers.

Contact: music music</textarea>
      <button class="btn copy-btn" onclick="copyText('privacy')">Copier</button>
    </div>
  </div>

  <script>
    // ===== FICHIERS EMBARQUES =====

    const FILES = {
      "manifest.json": `{
  "manifest_version": 3,
  "name": "__MSG_appName__",
  "short_name": "SecondMain",
  "version": "1.0.0",
  "description": "__MSG_appDescription__",
  "default_locale": "fr",
  "permissions": ["activeTab", "storage", "notifications"],
  "host_permissions": ["https://www.leboncoin.fr/*"],
  "action": {
    "default_popup": "popup.html",
    "default_title": "SecondMain - Chercher en occasion",
    "default_icon": {
      "16": "icons/icon16.png",
      "32": "icons/icon32.png",
      "48": "icons/icon48.png",
      "128": "icons/icon128.png"
    }
  },
  "content_scripts": [{
    "matches": [
      "https://www.leroymerlin.fr/*",
      "https://www.castorama.fr/*",
      "https://www.ikea.com/fr/*",
      "https://www.amazon.fr/*",
      "https://www.fnac.com/*",
      "https://www.darty.com/*",
      "https://www.boulanger.com/*",
      "https://www.cdiscount.com/*",
      "https://www.manomano.fr/*"
    ],
    "js": ["content.js"],
    "run_at": "document_idle"
  }],
  "background": { "service_worker": "background.js" },
  "icons": {
    "16": "icons/icon16.png",
    "32": "icons/icon32.png",
    "48": "icons/icon48.png",
    "128": "icons/icon128.png"
  }
}`,

      "_locales/fr/messages.json": `{
  "appName": { "message": "SecondMain - Trouve en occasion" },
  "appDescription": { "message": "Compare automatiquement les prix avec Le Bon Coin, Vinted et autres sites de seconde main." }
}`,

      "background.js": `// SecondMain - Background Service Worker
const LEBONCOIN_SEARCH_URL = 'https://www.leboncoin.fr/recherche';

chrome.runtime.onMessage.addListener((request, sender, sendResponse) => {
  if (request.action === 'searchSecondHand') {
    searchAndNotify(request.productName, request.price, sender.tab.id);
    sendResponse({ status: 'searching' });
  }
  return true;
});

async function searchAndNotify(productName, referencePrice, tabId) {
  try {
    const searchQuery = simplifyProductName(productName);
    const searchUrl = LEBONCOIN_SEARCH_URL + '?text=' + encodeURIComponent(searchQuery) + '&locations=r_12';

    const response = await fetch(searchUrl);
    if (!response.ok) return;

    const html = await response.text();
    const priceMatches = html.matchAll(/(\\d{1,4})\\s*‚Ç¨/g);
    const prices = [];
    for (const match of priceMatches) {
      const price = parseInt(match[1]);
      if (price > 5 && price < 10000) prices.push(price);
    }

    if (referencePrice && prices.length > 0) {
      const validPrices = prices.filter(p => ((referencePrice - p) / referencePrice) * 100 >= 20);
      if (validPrices.length > 0) {
        const bestPrice = Math.min(...validPrices);
        const savings = Math.round(((referencePrice - bestPrice) / referencePrice) * 100);

        chrome.storage.local.set({ lastResults: [{ price: bestPrice, savings }], lastProduct: productName });
        chrome.action.setBadgeText({ text: '!', tabId });
        chrome.action.setBadgeBackgroundColor({ color: '#10b981', tabId });

        chrome.notifications.create({
          type: 'basic',
          iconUrl: 'icons/icon128.png',
          title: 'SecondMain - Bonne affaire !',
          message: productName.substring(0, 50) + '... a partir de ' + bestPrice + '‚Ç¨ (-' + savings + '%)'
        });
      }
    }
  } catch (e) { console.log('SecondMain error:', e); }
}

function simplifyProductName(name) {
  const stopWords = ['le', 'la', 'les', 'de', 'du', 'des', 'un', 'une'];
  return name.toLowerCase().replace(/[^\\w\\s√†√¢√§√©√®√™√´√Ø√Æ√¥√π√ª√º√ß-]/g, ' ')
    .split(/\\s+/).filter(w => w.length > 2 && !stopWords.includes(w)).slice(0, 5).join(' ');
}`,

      "content.js": `// SecondMain - Content Script
(function() {
  const SELECTORS = {
    'leroymerlin.fr': { name: ['h1'], price: ['.product-price', '[itemprop="price"]'] },
    'castorama.fr': { name: ['h1'], price: ['.product-price'] },
    'ikea.com': { name: ['h1'], price: ['.pip-temp-price__integer'] },
    'amazon.fr': { name: ['#productTitle'], price: ['.a-price .a-offscreen'] },
    'fnac.com': { name: ['h1'], price: ['.f-productHeader-Price'] },
    'darty.com': { name: ['h1'], price: ['.product-price'] },
    'boulanger.com': { name: ['h1'], price: ['.product-price'] },
    'cdiscount.com': { name: ['h1'], price: ['.fpPrice'] },
    'manomano.fr': { name: ['h1'], price: ['[data-testid="price"]'] }
  };

  let searched = false;

  function getSite() {
    for (const s of Object.keys(SELECTORS)) if (location.hostname.includes(s)) return s;
    return null;
  }

  function find(selectors) {
    for (const sel of selectors) { const el = document.querySelector(sel); if (el) return el; }
    return null;
  }

  function getProduct() {
    const site = getSite();
    if (!site) return null;
    const sel = SELECTORS[site];
    const nameEl = find(sel.name);
    const priceEl = find(sel.price);
    if (!nameEl) return null;
    const priceMatch = priceEl?.textContent.replace(/\\s/g,'').match(/(\\d+(?:[.,]\\d+)?)/);
    return {
      productName: nameEl.textContent.replace(/\\s+/g,' ').trim().substring(0,150),
      price: priceMatch ? parseFloat(priceMatch[1].replace(',','.')) : null
    };
  }

  function triggerSearch() {
    if (searched) return;
    const info = getProduct();
    if (!info) return;
    searched = true;
    chrome.runtime.sendMessage({ action: 'searchSecondHand', productName: info.productName, price: info.price });
  }

  chrome.runtime.onMessage.addListener((req, sender, res) => {
    if (req.action === 'getProductInfo') res(getProduct());
    return true;
  });

  if (location.pathname !== '/' && location.pathname !== '/fr/') {
    setTimeout(triggerSearch, 5000);
  }
})();`,

      "popup.html": `<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,sans-serif;width:320px;background:#f8fafc}
    .header{background:linear-gradient(135deg,#10b981,#059669);color:white;padding:14px;text-align:center}
    .header h1{font-size:16px;display:flex;align-items:center;justify-content:center;gap:6px}
    .content{padding:14px}
    .product{background:white;border-radius:8px;padding:12px;margin-bottom:12px;box-shadow:0 1px 3px rgba(0,0,0,0.1)}
    .product-label{font-size:10px;color:#10b981;text-transform:uppercase;font-weight:600}
    .product-name{font-size:13px;color:#1e293b;margin-top:4px}
    .btn{display:block;width:100%;padding:10px;background:#10b981;color:white;border:none;border-radius:6px;font-size:13px;font-weight:500;cursor:pointer;text-decoration:none;text-align:center;margin-bottom:8px}
    .btn:hover{background:#059669}
    .btn.secondary{background:#e2e8f0;color:#64748b}
    .sources{display:flex;flex-wrap:wrap;gap:6px}
    .source{font-size:11px;padding:6px 10px;background:white;border:1px solid #e2e8f0;border-radius:6px;text-decoration:none;color:#64748b}
    .source:hover{border-color:#10b981;color:#10b981}
    .footer{padding:10px;text-align:center;font-size:10px;color:#94a3b8}
    .no-product{text-align:center;padding:30px;color:#64748b}
  </style>
</head>
<body>
  <div class="header"><h1>‚ôªÔ∏è SecondMain</h1></div>
  <div class="content">
    <div id="loading" class="no-product">Chargement...</div>
    <div id="main" style="display:none">
      <div class="product">
        <div class="product-label">Produit detecte</div>
        <div class="product-name" id="product-name">-</div>
      </div>
      <a id="lbc-link" href="#" target="_blank" class="btn">Chercher sur Le Bon Coin</a>
      <div class="sources">
        <a id="vinted-link" href="#" target="_blank" class="source">Vinted</a>
        <a id="fb-link" href="#" target="_blank" class="source">FB Marketplace</a>
        <a id="ebay-link" href="#" target="_blank" class="source">eBay</a>
      </div>
    </div>
    <div id="no-product" class="no-product" style="display:none">Va sur une page produit</div>
  </div>
  <div class="footer">Un Jour Une App - Jour 13</div>
  <script src="popup.js"></script>
</body>
</html>`,

      "popup.js": `document.addEventListener('DOMContentLoaded', async () => {
  const loading = document.getElementById('loading');
  const main = document.getElementById('main');
  const noProduct = document.getElementById('no-product');

  try {
    const [tab] = await chrome.tabs.query({ active: true, currentWindow: true });
    chrome.tabs.sendMessage(tab.id, { action: 'getProductInfo' }, (response) => {
      loading.style.display = 'none';
      if (!response || !response.productName) {
        noProduct.style.display = 'block';
        return;
      }
      main.style.display = 'block';
      document.getElementById('product-name').textContent = response.productName;

      const q = encodeURIComponent(response.productName.substring(0, 50));
      document.getElementById('lbc-link').href = 'https://www.leboncoin.fr/recherche?text=' + q + '&locations=r_12';
      document.getElementById('vinted-link').href = 'https://www.vinted.fr/catalog?search_text=' + q;
      document.getElementById('fb-link').href = 'https://www.facebook.com/marketplace/search/?query=' + q;
      document.getElementById('ebay-link').href = 'https://www.ebay.fr/sch/i.html?_nkw=' + q;
    });
  } catch (e) {
    loading.style.display = 'none';
    noProduct.style.display = 'block';
  }
});`
    };

    // ===== GENERATION ICONES =====
    const sizes = [16, 32, 48, 128];
    const canvases = {};

    function drawIcon(ctx, size) {
      const gradient = ctx.createLinearGradient(0, 0, size, size);
      gradient.addColorStop(0, '#10b981');
      gradient.addColorStop(1, '#059669');
      ctx.beginPath();
      ctx.roundRect(0, 0, size, size, size * 0.18);
      ctx.fillStyle = gradient;
      ctx.fill();
      ctx.strokeStyle = 'rgba(255,255,255,0.7)';
      ctx.lineWidth = Math.max(2, size * 0.06);
      ctx.setLineDash([size * 0.12, size * 0.06]);
      ctx.beginPath();
      ctx.arc(size/2, size/2, size*0.3, 0, Math.PI*2);
      ctx.stroke();
      ctx.setLineDash([]);
      ctx.fillStyle = 'white';
      ctx.font = `bold ${size*0.4}px Arial`;
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText('‚Ç¨', size/2, size/2 + size*0.02);
    }

    const preview = document.getElementById('icons-preview');
    sizes.forEach(size => {
      const canvas = document.createElement('canvas');
      canvas.width = size;
      canvas.height = size;
      drawIcon(canvas.getContext('2d'), size);
      preview.appendChild(canvas);
      canvases[size] = canvas;
    });

    function canvasToBlob(canvas) {
      return new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
    }

    // ===== GENERATION ZIP =====
    async function generateZip() {
      const btn = document.getElementById('generate-btn');
      const status = document.getElementById('status');
      btn.disabled = true;
      btn.textContent = '‚è≥ Generation...';
      status.className = 'status show';
      status.textContent = 'Creation du ZIP...';

      try {
        const zip = new JSZip();

        // Icones
        const iconsFolder = zip.folder('icons');
        for (const size of sizes) {
          const blob = await canvasToBlob(canvases[size]);
          iconsFolder.file(`icon${size}.png`, blob);
        }

        // Fichiers
        for (const [path, content] of Object.entries(FILES)) {
          if (path.includes('/')) {
            const parts = path.split('/');
            let folder = zip;
            for (let i = 0; i < parts.length - 1; i++) {
              folder = folder.folder(parts[i]);
            }
            folder.file(parts[parts.length - 1], content);
          } else {
            zip.file(path, content);
          }
        }

        const blob = await zip.generateAsync({ type: 'blob' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'SecondMain.zip';
        a.click();
        URL.revokeObjectURL(url);

        btn.textContent = '‚úì Telecharge !';
        status.textContent = '‚úÖ SecondMain.zip pret ! Upload-le sur le Chrome Web Store.';
      } catch (e) {
        status.textContent = '‚ùå Erreur: ' + e.message;
        btn.textContent = 'Reessayer';
        btn.disabled = false;
      }
    }

    window.generateZip = generateZip;

    function copyText(id) {
      document.getElementById(id).select();
      document.execCommand('copy');
      event.target.textContent = 'Copie !';
      setTimeout(() => event.target.textContent = 'Copier', 2000);
    }
    window.copyText = copyText;
  </script>
</body>
</html>
