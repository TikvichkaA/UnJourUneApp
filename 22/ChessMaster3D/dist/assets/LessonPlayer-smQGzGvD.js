import{j as e,m as d,a as $,u as D,r as l}from"./index-C4qqbxA3.js";import{C as g,f as E,a as I,b as T,c as Z}from"./CameraControls-CGnJSejw.js";import{A as w}from"./index-CC1_5B0R.js";import{u as F}from"./progressStore-B8khYM18.js";import{l as B}from"./lessons-xSRSB9NW.js";import"./middleware-EJ6QVAsm.js";function O({hint:s,onRequestHint:n,hintsUsed:a,maxHints:i=3,showButton:t=!0}){const o=a<i;return e.jsxs("div",{className:"absolute bottom-24 left-1/2 -translate-x-1/2",children:[e.jsx(w,{mode:"wait",children:s&&s.level!=="none"&&s.explanation&&e.jsxs(d.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:-20},className:"glass px-6 py-3 rounded-xl mb-3 text-center",children:[e.jsxs("div",{className:"flex items-center gap-2 text-wood-accent",children:[e.jsx(U,{level:s.level}),e.jsx("span",{className:"text-sm font-medium",children:K(s.level)})]}),e.jsx("p",{className:"text-wood-light mt-1",children:s.explanation})]},"hint-display")}),t&&e.jsxs(d.button,{initial:{opacity:0},animate:{opacity:1},onClick:n,disabled:!o,className:`btn-secondary flex items-center gap-2 mx-auto ${o?"":"opacity-50 cursor-not-allowed"}`,children:[e.jsx("svg",{className:"w-5 h-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"})}),e.jsxs("span",{children:["Indice (",i-a," restants)"]})]})]})}function U({level:s}){switch(s){case"zone":return e.jsx("svg",{className:"w-4 h-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"})});case"piece":return e.jsx("svg",{className:"w-4 h-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"})});case"move":return e.jsx("svg",{className:"w-4 h-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M13 7l5 5m0 0l-5 5m5-5H6"})});default:return null}}function K(s){switch(s){case"zone":return"Zone";case"piece":return"Pièce";case"move":return"Solution";default:return""}}function J({type:s,message:n,onDismiss:a}){const i={success:"border-green-500 bg-green-500/10",error:"border-red-500 bg-red-500/10",info:"border-blue-500 bg-blue-500/10"},t={success:e.jsx("svg",{className:"w-6 h-6 text-green-400",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 13l4 4L19 7"})}),error:e.jsx("svg",{className:"w-6 h-6 text-red-400",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})}),info:e.jsx("svg",{className:"w-6 h-6 text-blue-400",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})})};return e.jsx(d.div,{initial:{opacity:0,scale:.9,y:20},animate:{opacity:1,scale:1,y:0},exit:{opacity:0,scale:.9,y:20},className:`fixed bottom-20 left-1/2 -translate-x-1/2 glass border ${i[s]} px-6 py-4 rounded-xl max-w-md`,onClick:a,children:e.jsxs("div",{className:"flex items-start gap-3",children:[t[s],e.jsx("p",{className:"text-wood-light",children:n})]})})}function z(s,n,a){if(a==="none"||n.length===0)return{level:"none"};const i=new g(s.fen());let t=null;for(const o of n)try{t=i.move(o);break}catch{continue}if(!t)return{level:"none"};switch(a){case"zone":return{level:"zone",zone:Q(t.to),explanation:`Regardez du côté ${X(t.to)}`};case"piece":return{level:"piece",piece:t.from,explanation:`Utilisez votre ${Y(t.piece)}`};case"move":return{level:"move",move:{from:t.from,to:t.to},explanation:`Le coup est ${t.san}`};default:return{level:"none"}}}function Q(s){const n=s.charCodeAt(0)-97;return n<=2?"queenside":n>=5?"kingside":"center"}function X(s){const n=s.charCodeAt(0)-97;return n<=2?"de l'aile Dame":n>=5?"de l'aile Roi":"du centre"}function Y(s){return{p:"pion",n:"cavalier",b:"fou",r:"tour",q:"dame",k:"roi"}[s.toLowerCase()]||"pièce"}function _(s,n,a){const i=new g(s.fen());try{const t=i.move({from:n.from,to:n.to});return t?a.some(c=>{const u=new g(s.fen());try{const f=u.move(c);return f&&f.from===t.from&&f.to===t.to}catch{return!1}})?{isCorrect:!0,explanation:""}:i.isCheckmate()?{isCorrect:!1,explanation:"Ce coup mène au mat, mais pas le bon !"}:i.isCheck()?{isCorrect:!1,explanation:"L'échec n'est pas la meilleure continuation ici."}:(t.captured?ee(t.captured):0)>0&&!te(i,t.to)?{isCorrect:!1,explanation:"Cette capture laisse votre pièce en prise."}:{isCorrect:!1,explanation:"Ce coup ne réalise pas l'objectif. Cherchez mieux !"}:{isCorrect:!1,explanation:"Ce coup est illégal."}}catch{return{isCorrect:!1,explanation:"Coup invalide."}}}function ee(s){return{p:1,n:3,b:3,r:5,q:9,k:0}[s.toLowerCase()]||0}function te(s,n){const a=s.turn(),i=["a","b","c","d","e","f","g","h"],t=["1","2","3","4","5","6","7","8"];for(const o of i)for(const v of t){const c=o+v,u=s.get(c);if(u&&u.color===a&&s.moves({square:c,verbose:!0}).some(p=>p.to===n))return!0}return!1}function se(s,n,a){return a===0?{level:"none"}:a===1?z(s,n,"zone"):a===2?z(s,n,"piece"):z(s,n,"move")}function ce(){const{lessonId:s}=$(),n=D(),{completeLesson:a,failLesson:i}=F(),t=l.useMemo(()=>{for(const r of B.chapters){const m=r.lessons.find(x=>x.id===s);if(m)return m}return null},[s]),[o,v]=l.useState(null),[c,u]=l.useState(null),[f,p]=l.useState([]),[P,C]=l.useState(null),[h,y]=l.useState("intro"),[N,j]=l.useState(null),[k,L]=l.useState(0),[,M]=l.useState(0),[W,S]=l.useState(null);l.useEffect(()=>{if(t){const r=new g(t.fen);v(r),u(null),p([]),C(null),y("intro"),j(null),L(0),M(0),S(null)}},[t]);const A=l.useCallback(r=>{if(!o||h!=="play")return;if(c&&f.includes(r)){const x=_(o,{from:c,to:r},(t==null?void 0:t.bestMoves)||[]);x.isCorrect?o.move({from:c,to:r})&&(C({from:c,to:r}),y("success"),j({type:"success",message:(t==null?void 0:t.successText)||"Excellent !"}),t&&a(t.id,t.skill)):(M(b=>b+1),j({type:"error",message:x.explanation||(t==null?void 0:t.failureText)||"Ce n'est pas le bon coup."}),t&&i(t.id)),u(null),p([]);return}const m=o.get(r);if(m&&m.color===o.turn()){const x=o.moves({square:r,verbose:!0});u(r),p(x.map(b=>b.to))}else u(null),p([])},[o,h,c,f,t,a,i]),V=l.useCallback(()=>{if(!o||!t||k>=3)return;const r=k+1;L(r);const m=se(o,t.bestMoves,r);S(m)},[o,t,k]),G=l.useCallback(()=>{if(t){const r=new g(t.fen);v(r),u(null),p([]),C(null),y("play"),j(null),L(0),M(0),S(null)}},[t]),R=l.useCallback(()=>{let r=!1;for(const m of B.chapters)for(const x of m.lessons){if(r){n(`/lesson/${x.id}`);return}x.id===s&&(r=!0)}n("/")},[s,n]);if(!t||!o)return e.jsx("div",{className:"h-screen flex items-center justify-center",children:e.jsx("p",{className:"text-wood-accent",children:"Leçon non trouvée"})});const H=o.isCheck(),q=H?E(o.fen(),o.turn()):null;return e.jsxs("div",{className:"h-screen w-screen relative overflow-hidden",children:[e.jsxs(d.button,{initial:{opacity:0,x:-20},animate:{opacity:1,x:0},onClick:()=>n("/"),className:"absolute top-4 left-4 z-10 glass px-4 py-2 rounded-xl flex items-center gap-2 hover:border-wood-accent transition-colors",children:[e.jsx("svg",{className:"w-5 h-5 text-wood-light",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M10 19l-7-7m0 0l7-7m-7 7h18"})}),e.jsx("span",{className:"text-wood-light",children:"Retour"})]}),e.jsx(d.div,{initial:{opacity:0,y:-20},animate:{opacity:1,y:0},className:"absolute top-4 left-1/2 -translate-x-1/2 z-10 glass px-6 py-3 rounded-xl",children:e.jsx("h1",{className:"text-lg font-medium text-wood-light",children:t.title})}),e.jsxs(I,{shadows:!0,camera:{position:[0,8,10],fov:45},gl:{antialias:!0},children:[e.jsx("ambientLight",{intensity:.4}),e.jsx("directionalLight",{position:[10,15,10],intensity:1,castShadow:!0,"shadow-mapSize":[2048,2048]}),e.jsx("directionalLight",{position:[-5,10,-5],intensity:.3}),e.jsx("fog",{attach:"fog",args:["#1a0f0a",15,40]}),e.jsx(T,{fen:o.fen(),selectedSquare:c,legalMoves:f,lastMove:P,onSquareClick:A,isCheck:H,checkSquare:q,interactive:h==="play"}),e.jsxs("mesh",{rotation:[-Math.PI/2,0,0],position:[0,-.3,0],receiveShadow:!0,children:[e.jsx("planeGeometry",{args:[50,50]}),e.jsx("meshStandardMaterial",{color:"#1a0f0a",roughness:.9})]}),e.jsx(Z,{})]}),e.jsx(w,{children:h==="intro"&&e.jsx(d.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"absolute inset-0 bg-black/60 flex items-center justify-center z-20",children:e.jsxs(d.div,{initial:{scale:.9,opacity:0},animate:{scale:1,opacity:1},exit:{scale:.9,opacity:0},className:"glass rounded-2xl p-8 max-w-md text-center",children:[e.jsx("div",{className:"w-16 h-16 rounded-full bg-gradient-to-br from-wood-medium to-yellow-500 flex items-center justify-center mx-auto mb-4",children:e.jsx("svg",{className:"w-8 h-8 text-wood-dark",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"})})}),e.jsx("h2",{className:"text-2xl font-display font-bold text-wood-light mb-3",children:t.title}),e.jsx("p",{className:"text-wood-accent mb-6",children:t.intro}),e.jsx("button",{onClick:()=>y("play"),className:"btn-primary",children:"C'est parti !"})]})})}),e.jsx(w,{children:h==="success"&&e.jsx(d.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"absolute inset-0 bg-black/60 flex items-center justify-center z-20",children:e.jsxs(d.div,{initial:{scale:.9,opacity:0},animate:{scale:1,opacity:1},className:"glass rounded-2xl p-8 max-w-md text-center glow-success",children:[e.jsx(d.div,{initial:{scale:0},animate:{scale:1},transition:{delay:.2,type:"spring"},className:"w-20 h-20 rounded-full bg-gradient-to-br from-green-500 to-green-400 flex items-center justify-center mx-auto mb-4",children:e.jsx("svg",{className:"w-10 h-10 text-white",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:3,d:"M5 13l4 4L19 7"})})}),e.jsx("h2",{className:"text-2xl font-display font-bold text-wood-light mb-3",children:"Excellent !"}),e.jsx("p",{className:"text-wood-accent mb-6",children:t.successText}),e.jsxs("div",{className:"flex gap-4 justify-center",children:[e.jsx("button",{onClick:G,className:"btn-secondary",children:"Rejouer"}),e.jsx("button",{onClick:R,className:"btn-primary",children:"Suivant"})]})]})})}),h==="play"&&e.jsx(O,{hint:W,onRequestHint:V,hintsUsed:k,maxHints:3}),e.jsx(w,{children:N&&h==="play"&&e.jsx(J,{type:N.type,message:N.message,onDismiss:()=>j(null)})})]})}export{ce as default};
